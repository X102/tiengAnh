<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Reading Comprehension Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 100%;
            max-width: 900px;
            overflow: hidden;
        }
        .text-content {
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
            line-height: 1.6;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 300px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .text-content span.word-clickable {
            cursor: pointer;
            padding: 2px 0;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .text-content span.word-clickable:hover {
            background-color: #e0e7ff; /* Light blue on hover */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.0);
            z-index: 999;
            display: none;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            position: absolute;
            max-width: 280px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            animation: fadeIn 0.2s ease-out;
            cursor: grab;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .button-base {
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
        }
        .button-base:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-base:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        .button-base:active:not(:disabled) {
            transform: translateY(0);
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .button-secondary {
            background-color: #6b7280;
            color: white;
        }
        .button-secondary:hover:not(:disabled) {
            background-color: #4b5563;
        }
        .link-button {
            display: block;
            background-color: #eff6ff;
            color: #1d4ed8;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.9rem;
        }
        .link-button:hover {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .section-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        #ai-results-section, #explanation-section, #grammar-check-section, #reference-section {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e5e7eb;
        }
        #vietnamese-translation-result, #selection-translate-result {
            margin-top: 10px;
            padding: 8px;
            background-color: #f0f4f8;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #333;
            border: 1px solid #d1e0ed;
        }
        .text-selection-popup {
            max-width: 320px;
            padding: 10px;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: grab;
            position: absolute;
            z-index: 1001;
        }
        .close-button {
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
            padding: 2px;
        }
        .close-button:hover {
            color: #374151;
        }
        .tts-controls {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background-color: #f9fafb;
        }
        #tts-progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            cursor: pointer;
            height: 10px;
        }
        #tts-progress-bar {
            height: 100%;
            background-color: #4f46e5;
            border-radius: 9999px;
            width: 0%;
            transition: width 0.1s linear;
        }
        #reference-section ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        #reference-section li {
            margin-bottom: 0.5rem;
        }
        #reference-section a {
            color: #3b82f6;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">üá¨üáß English Learning Tool</h1>

        <div class="space-y-4 mb-4">
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <label for="file-upload" class="button-base button-secondary cursor-pointer">Upload File</label>
                <input type="file" id="file-upload" class="hidden" accept=".txt,.docx">
                <span id="file-name" class="text-gray-600 text-sm"></span>
                <input type="url" id="web-url-input" placeholder="Or paste a URL..." class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full">
                <button id="fetch-url-button" class="button-base button-primary">Fetch</button>
            </div>
            <div class="mt-2">
                <label for="text-input-area" class="block mb-2 text-sm font-medium text-gray-700">Or enter text directly:</label>
                <textarea id="text-input-area" rows="5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Paste or type your English text here..."></textarea>
                <button id="process-text-button" class="button-base button-primary mt-2">Process Text</button>
            </div>
            <div class="flex flex-wrap items-center justify-center gap-4 pt-4">
                <button id="grammar-check-button" class="button-base button-secondary">Check Grammar (AI)</button>
                <button id="explain-text-button" class="button-base button-secondary">Explain Text (AI)</button>
            </div>
             <div class="tts-controls mt-4 space-y-3">
                <h3 class="text-lg font-medium text-center">Text-to-Speech Tool</h3>
                <div class="flex items-center gap-4">
                    <button id="tts-play-pause" class="button-base button-primary flex items-center justify-center w-28">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1zm6 0a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span id="play-pause-text" class="ml-2">Play</span>
                    </button>
                    <button id="tts-stop" class="button-base button-secondary">Stop</button>
                    <div id="tts-progress-container" class="flex-grow"><div id="tts-progress-bar"></div></div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <div class="flex items-center space-x-2">
                        <label for="tts-voice" class="text-sm font-medium">Voice:</label>
                        <select id="tts-voice" class="p-2 border border-gray-300 rounded-md shadow-sm text-sm"></select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="tts-rate" class="text-sm font-medium">Speed:</label>
                        <input type="range" id="tts-rate" min="0.5" max="2" value="1" step="0.1" class="w-24">
                        <span id="tts-rate-label" class="text-sm font-mono">1.0x</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="text-display" class="text-content">
            Please upload a file, paste a URL, or enter text to begin.
        </div>

        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">Generate Sentences & Vocab (AI)</h3>
            <div class="flex items-center gap-2">
                <input type="text" id="ai-custom-input" placeholder="Enter a word or phrase..." class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full">
                <button id="ai-generate-custom-button" class="button-base button-primary">Generate</button>
            </div>
            <div id="loading-spinner" class="loading-spinner"></div>
            <div id="ai-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden">
                <div class="section-header">
                    <h3>AI Results</h3>
                    <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Collapse</button>
                </div>
                <div id="ai-text-content" class="section-content text-left"></div>
            </div>
        </div>

        <div id="grammar-check-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Grammar Check (AI)</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Collapse</button>
            </div>
            <div id="grammar-check-content" class="text-gray-700 text-content section-content"></div>
            <div id="grammar-check-loading-spinner" class="loading-spinner"></div>
        </div>
        
        <div id="explanation-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Text Explanation (AI)</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Collapse</button>
            </div>
            <div id="explanation-content" class="text-gray-700 section-content"></div>
            <div id="explanation-loading-spinner" class="loading-spinner"></div>
        </div>

        <div id="reference-section">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">üìö Reference Websites</h3>
            <ul>
                <li><a href="https://dictionary.cambridge.org/" target="_blank">Cambridge Dictionary</a> - Excellent dictionary with examples and English-Vietnamese translations.</li>
                <li><a href="https://youglish.com/" target="_blank">YouGlish</a> - Find pronunciation in real-world YouTube videos.</li>
                <li><a href="https://www.oxfordlearnersdictionaries.com/" target="_blank">Oxford Learner's Dictionaries</a> - Great resource for ESL/EFL learners.</li>
                <li><a href="https://www.thesaurus.com/" target="_blank">Thesaurus.com</a> - Find synonyms and antonyms.</li>
                <li><a href="https://en.wiktionary.org/wiki/Wiktionary:Main_Page" target="_blank">Wiktionary</a> - Open-source dictionary with detailed etymology and usage notes.</li>
                <li>*This website was adapted by Gemini from a tool by <a href="https://www.facebook.com/lopmaybay" target="_blank">Ph·∫°m ƒêƒÉng Hi·ªÉn</a>.</li>
            </ul>
        </div>

        <div id="lookup-modal" class="modal-overlay">
            <div id="modal-content-inner" class="modal-content">
                <button id="close-lookup-modal" class="close-button" title="Close">&times;</button>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Lookup: <span id="selected-word-modal" class="font-bold text-indigo-600"></span></h2>
                <div class="space-y-2">
                    <a id="cambridge-link" href="#" target="_blank" class="link-button">Cambridge Dictionary (EN-VI)</a>
                    <a id="youglish-link" href="#" target="_blank" class="link-button">Check Pronunciation (YouGlish)</a>
                    <a id="wiktionary-link" href="#" target="_blank" class="link-button">Check Wiktionary</a>
                </div>
                <div id="vietnamese-translation-result" class="mt-4"></div>
                <div id="translate-loading-spinner" class="loading-spinner"></div>
            </div>
        </div>

        <div id="selection-popup" class="modal-content text-selection-popup hidden">
            <button id="close-selection-popup" class="close-button" title="Close">&times;</button>
            <div class="flex flex-col space-y-2">
                <button id="copy-selection-button" class="button-base button-secondary w-full">Copy</button>
                <button id="translate-selection-button" class="button-base button-primary w-full">Translate to Vietnamese</button>
            </div>
            <div id="selection-translate-result" class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-gray-700 text-sm hidden"></div>
            <div id="selection-translate-spinner" class="loading-spinner"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    
    <script>
        function mainApp() {
            // --- DOM Elements ---
            const textDisplay = document.getElementById('text-display');
            const grammarCheckButton = document.getElementById('grammar-check-button');
            const explainTextButton = document.getElementById('explain-text-button');
            const lookupModalOverlay = document.getElementById('lookup-modal');
            const modalContentInner = document.getElementById('modal-content-inner');
            const selectedWordModalSpan = document.getElementById('selected-word-modal');
            const cambridgeLink = document.getElementById('cambridge-link');
            const youglishLink = document.getElementById('youglish-link');
            const wiktionaryLink = document.getElementById('wiktionary-link');
            const vietnameseTranslationResultDiv = document.getElementById('vietnamese-translation-result');
            const translateLoadingSpinner = document.getElementById('translate-loading-spinner');
            const aiCustomInput = document.getElementById('ai-custom-input');
            const aiGenerateCustomButton = document.getElementById('ai-generate-custom-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const aiResultsSection = document.getElementById('ai-results-section');
            const aiTextContentDiv = document.getElementById('ai-text-content');
            const explanationSection = document.getElementById('explanation-section');
            const explanationContentDiv = document.getElementById('explanation-content');
            const explanationLoadingSpinner = document.getElementById('explanation-loading-spinner');
            const grammarCheckSection = document.getElementById('grammar-check-section');
            const grammarCheckContentDiv = document.getElementById('grammar-check-content');
            const grammarCheckLoadingSpinner = document.getElementById('grammar-check-loading-spinner');
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameSpan = document.getElementById('file-name');
            const selectionPopup = document.getElementById('selection-popup');
            const copySelectionButton = document.getElementById('copy-selection-button');
            const translateSelectionButton = document.getElementById('translate-selection-button');
            const selectionTranslateResultDiv = document.getElementById('selection-translate-result');
            const selectionTranslateSpinner = document.getElementById('selection-translate-spinner');
            const webUrlInput = document.getElementById('web-url-input');
            const fetchUrlButton = document.getElementById('fetch-url-button');
            const closeLookupModalBtn = document.getElementById('close-lookup-modal');
            const closeSelectionPopupBtn = document.getElementById('close-selection-popup');
            const textInputArea = document.getElementById('text-input-area');
            const processTextButton = document.getElementById('process-text-button');
            
            // TTS Controls
            const ttsPlayPauseBtn = document.getElementById('tts-play-pause');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const playPauseText = document.getElementById('play-pause-text');
            const ttsStopBtn = document.getElementById('tts-stop');
            const ttsVoiceSelect = document.getElementById('tts-voice');
            const ttsRateSlider = document.getElementById('tts-rate');
            const ttsRateLabel = document.getElementById('tts-rate-label');
            const ttsProgressContainer = document.getElementById('tts-progress-container');
            const ttsProgressBar = document.getElementById('tts-progress-bar');

            // --- State Variables ---
            let currentRawText = '';
            let justEndedDrag = false;
            let voices = [];
            let speechStartIndex = 0;
            
            // --- Helper Functions ---
            function makeDraggable(element) {
                let isDragging = false;
                let initialMouseX, initialMouseY, initialElementLeft, initialElementTop;

                element.addEventListener("mousedown", dragStart);

                function dragStart(e) {
                    if (e.target.closest('a, button, .close-button')) return;
                    isDragging = true;
                    element.style.cursor = 'grabbing';
                    element.style.zIndex = 1001;
                    const rect = element.getBoundingClientRect();
                    initialElementLeft = rect.left;
                    initialElementTop = rect.top;
                    initialMouseX = e.clientX;
                    initialMouseY = e.clientY;
                    e.preventDefault();
                    e.stopPropagation();
                    justEndedDrag = false;
                }

                document.addEventListener("mousemove", (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        const dx = e.clientX - initialMouseX;
                        const dy = e.clientY - initialMouseY;
                        element.style.left = `${initialElementLeft + dx}px`;
                        element.style.top = `${initialElementTop + dy}px`;
                    }
                });

                document.addEventListener("mouseup", () => {
                    if (isDragging) {
                        isDragging = false;
                        element.style.cursor = 'grab';
                        element.style.zIndex = 1000;
                        justEndedDrag = true;
                        setTimeout(() => { justEndedDrag = false; }, 100);
                    }
                });
            }

            function addClickableSpansTo(element) {
                const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
                let node;
                const nodesToProcess = [];
                while (node = walker.nextNode()) {
                    nodesToProcess.push(node);
                }

                nodesToProcess.forEach(textNode => {
                    if (/[a-zA-Z]/.test(textNode.nodeValue)) { // Check for English letters
                        const parent = textNode.parentNode;
                        const parts = textNode.nodeValue.split(/([a-zA-Z'-]+)/g); // Regex for English words
                        
                        const fragment = document.createDocumentFragment();
                        parts.forEach(part => {
                            if (part.match(/^[a-zA-Z'-]+$/)) { // Check if the part is a word
                                const span = document.createElement('span');
                                span.textContent = part;
                                span.className = 'word-clickable';
                                span.addEventListener('click', (event) => {
                                    event.stopPropagation();
                                    selectionPopup.classList.add('hidden');
                                    openLookupModal(part, event);
                                    aiCustomInput.value = part; // Populate the input field
                                });
                                fragment.appendChild(span);
                            } else {
                                fragment.appendChild(document.createTextNode(part));
                            }
                        });
                        
                        parent.replaceChild(fragment, textNode);
                    }
                });
            }

            function processNewContent(htmlContent, isHtml = false) {
                speechSynthesis.cancel();
                if (isHtml) {
                    textDisplay.innerHTML = htmlContent;
                    addClickableSpansTo(textDisplay);
                    currentRawText = textDisplay.innerText;
                } else {
                    currentRawText = htmlContent;
                    textDisplay.innerHTML = '';
                    const fragment = document.createDocumentFragment();
                    const parts = currentRawText.split(/([a-zA-Z'-]+)/g);
                    parts.forEach(part => {
                        if (part.match(/^[a-zA-Z'-]+$/)) {
                            const span = document.createElement('span');
                            span.textContent = part;
                            span.className = 'word-clickable';
                            span.addEventListener('click', (event) => {
                                event.stopPropagation();
                                selectionPopup.classList.add('hidden');
                                openLookupModal(part, event);
                                aiCustomInput.value = part;
                            });
                            fragment.appendChild(span);
                        } else {
                            fragment.appendChild(document.createTextNode(part));
                        }
                    });
                    textDisplay.appendChild(fragment);
                }
                [aiResultsSection, explanationSection, grammarCheckSection, lookupModalOverlay, selectionPopup].forEach(el => el.classList.add('hidden'));
            }

            async function getVietnameseTranslation(word) {
                translateLoadingSpinner.style.display = 'block';
                selectionTranslateSpinner.style.display = 'block';
                // IMPORTANT: Replace with your own Google AI Gemini API Key
                const apiKey = "YOUR_GEMINI_API_KEY"; 
                if (apiKey === "YOUR_GEMINI_API_KEY") {
                     const errorMsg = "L·ªói: Vui l√≤ng th√™m Gemini API Key v√†o code.";
                     console.error(errorMsg);
                     translateLoadingSpinner.style.display = 'none';
                     selectionTranslateSpinner.style.display = 'none';
                     return errorMsg;
                }
                try {
                    const prompt = `Translate the English word or phrase "${word}" into Vietnamese. Provide only the Vietnamese translation(s), without any additional explanatory text.`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "text/plain" } };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text.trim();
                    }
                    throw new Error("Unexpected AI response structure");
                } catch (error) {
                    console.error("Error calling AI for translation:", error);
                    return `Translation error.`;
                } finally {
                    translateLoadingSpinner.style.display = 'none';
                    selectionTranslateSpinner.style.display = 'none';
                }
            }
            
            async function openLookupModal(word, event) {
                selectedWordModalSpan.textContent = word;
                const encodedWord = encodeURIComponent(word);
                cambridgeLink.href = `https://dictionary.cambridge.org/dictionary/english-vietnamese/${encodedWord}`;
                youglishLink.href = `https://youglish.com/pronounce/${encodedWord}/english`;
                wiktionaryLink.href = `https://en.wiktionary.org/wiki/${encodedWord}`;
                vietnameseTranslationResultDiv.innerHTML = '';
                lookupModalOverlay.style.display = 'block';
                modalContentInner.style.visibility = 'hidden';

                const rect = event.target.getBoundingClientRect();
                modalContentInner.style.left = `${rect.left}px`;
                modalContentInner.style.top = `${rect.bottom + 5}px`;
                modalContentInner.style.visibility = 'visible';

                const translation = await getVietnameseTranslation(word);
                vietnameseTranslationResultDiv.innerHTML = `<strong>Vietnamese:</strong> ${translation}`;
            }

            makeDraggable(modalContentInner);
            makeDraggable(selectionPopup);

            async function callAI(prompt, responseMimeType, responseSchema) {
                // IMPORTANT: Replace with your own Google AI Gemini API Key
                const apiKey = "YOUR_GEMINI_API_KEY"; 
                if (apiKey === "YOUR_GEMINI_API_KEY") {
                    throw new Error("API Key not set. Please replace 'YOUR_GEMINI_API_KEY' in the script.");
                }
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType }
                };
                if (responseSchema) {
                    payload.generationConfig.responseSchema = responseSchema;
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status} - ${await response.text()}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                }
                throw new Error("Unexpected AI response structure");
            }
            
            // --- Event Listeners ---
            
            document.addEventListener('mousedown', (event) => {
                if (justEndedDrag) return;
                const clickedInsideLookup = modalContentInner.contains(event.target);
                const clickedInsideSelection = selectionPopup.contains(event.target);
                const clickedOnWord = event.target.closest('.word-clickable');

                if (lookupModalOverlay.style.display === 'block' && !clickedInsideLookup && !clickedOnWord) {
                    lookupModalOverlay.style.display = 'none';
                }
                if (!selectionPopup.classList.contains('hidden') && !clickedInsideSelection) {
                    if (window.getSelection().toString().length === 0) {
                        selectionPopup.classList.add('hidden');
                    }
                }
            });

            closeLookupModalBtn.addEventListener('click', () => lookupModalOverlay.style.display = 'none');
            closeSelectionPopupBtn.addEventListener('click', () => selectionPopup.classList.add('hidden'));

            aiGenerateCustomButton.addEventListener('click', async () => {
                const word = aiCustomInput.value.trim();
                if (!word) { alert("Please enter a word or phrase."); return; }
                
                loadingSpinner.style.display = 'block';
                aiResultsSection.classList.remove('hidden');
                aiTextContentDiv.innerHTML = '';
                aiGenerateCustomButton.disabled = true;

                try {
                    const prompt = `For the English word or phrase "${word}", create a JSON object with three properties: "sentences", "synonyms", and "antonyms". "sentences" must be an array of 5 example sentences. "synonyms" and "antonyms" must each be an array of up to 10 relevant words.`;
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "sentences": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "synonyms": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "antonyms": { "type": "ARRAY", "items": { "type": "STRING" } }
                        }
                    };
                    const jsonString = await callAI(prompt, "application/json", schema);
                    const data = JSON.parse(jsonString);
                    
                    let htmlContent = '<h4 class="text-lg font-semibold mb-2">Example Sentences:</h4><ul class="list-disc list-inside space-y-1">';
                    (data.sentences || []).forEach(s => { htmlContent += `<li>${s}</li>`; });
                    htmlContent += '</ul><h4 class="text-lg font-semibold mt-4 mb-2">Synonyms:</h4><p class="text-gray-600">';
                    htmlContent += (data.synonyms || ["N/A"]).join(', ');
                    htmlContent += '</p><h4 class="text-lg font-semibold mt-4 mb-2">Antonyms:</h4><p class="text-gray-600">';
                    htmlContent += (data.antonyms || ["N/A"]).join(', ');
                    htmlContent += '</p>';
                    aiTextContentDiv.innerHTML = htmlContent;

                } catch (error) {
                    aiTextContentDiv.innerHTML = `<p class="text-red-600">Error calling AI: ${error.message}. Please try again.</p>`;
                    console.error("Error calling AI:", error);
                } finally {
                    loadingSpinner.style.display = 'none';
                    aiGenerateCustomButton.disabled = false;
                }
            });

            grammarCheckButton.addEventListener('click', async () => {
                if (!currentRawText) return;
                grammarCheckButton.disabled = true;
                grammarCheckLoadingSpinner.style.display = 'block';
                grammarCheckSection.classList.remove('hidden');
                grammarCheckContentDiv.innerHTML = '';
                try {
                    const prompt = `Please check the following English text for grammar and spelling errors. Provide a corrected version of the text, and if there are corrections, briefly explain them in Vietnamese. Format the output as a JSON object with two keys: "corrected_text" and "explanation".\n\nText:\n${currentRawText}`;
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "corrected_text": {"type": "STRING"},
                            "explanation": {"type": "STRING"}
                        }
                    };
                    const jsonString = await callAI(prompt, "application/json", schema);
                    const result = JSON.parse(jsonString);
                    let content = `<div class="text-content">${result.corrected_text}</div>`;
                    if(result.explanation){
                        content += `<h4 class="text-md font-semibold mt-4">Explanation (Vietnamese):</h4><p>${result.explanation.replace(/\n/g, '<br>')}</p>`;
                    }
                    grammarCheckContentDiv.innerHTML = content;
                    addClickableSpansTo(grammarCheckContentDiv.querySelector('.text-content'));
                } catch (error) {
                    grammarCheckContentDiv.innerHTML = `<p class="text-red-600">Error during grammar check: ${error.message}.</p>`;
                } finally {
                    grammarCheckButton.disabled = false;
                    grammarCheckLoadingSpinner.style.display = 'none';
                }
            });

            explainTextButton.addEventListener('click', async () => {
                if (!currentRawText) return;
                explainTextButton.disabled = true;
                explanationLoadingSpinner.style.display = 'block';
                explanationSection.classList.remove('hidden');
                explanationContentDiv.innerHTML = '';
                try {
                    const prompt = `Explain the grammar, vocabulary, and key concepts in the following English text in detail. The explanation should be in Vietnamese and targeted at an English language learner. Use formatting like bolding and bullet points for clarity.\n\nText:\n${currentRawText}`;
                    const explanation = await callAI(prompt, "text/plain");
                    explanationContentDiv.innerHTML = explanation.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                } catch (error) {
                    explanationContentDiv.innerHTML = `<p class="text-red-600">Error getting explanation from AI: ${error.message}.</p>`;
                } finally {
                    explainTextButton.disabled = false;
                    explanationLoadingSpinner.style.display = 'none';
                }
            });

            fileUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                fileNameSpan.textContent = file.name;
                textInputArea.value = ''; webUrlInput.value = '';
                textDisplay.textContent = 'Processing file...';
                const reader = new FileReader();
                if (file.name.endsWith('.docx')) {
                    reader.onload = (e) => {
                        window.mammoth.convertToHtml({ arrayBuffer: e.target.result })
                            .then(result => processNewContent(result.value, true))
                            .catch(error => textDisplay.textContent = `Error processing DOCX: ${error.message}`);
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.onload = (e) => processNewContent(e.target.result, false);
                    reader.readAsText(file);
                }
            });

            fetchUrlButton.addEventListener('click', async () => {
                const url = webUrlInput.value.trim();
                if (!url) { alert("Please enter a URL."); return; }
                textInputArea.value = ''; fileUploadInput.value = ''; fileNameSpan.textContent = '';
                textDisplay.textContent = `Fetching content from ${url}...`;
                try {
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    if (!response.ok) throw new Error(`Network error: ${response.status}`);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    doc.querySelectorAll('script, style').forEach(el => el.remove());
                    let text = doc.body.innerText || "Could not extract main content.";
                    processNewContent(text, false);
                    fileNameSpan.textContent = `Content from: ${url}`;
                } catch (error) {
                    textDisplay.textContent = `Could not fetch content. This might be due to security restrictions (CORS) or an invalid URL. Error: ${error.message}`;
                }
            });

            processTextButton.addEventListener('click', () => {
                const text = textInputArea.value.trim();
                if (!text) { alert("Please enter text into the box."); return; }
                fileUploadInput.value = ''; webUrlInput.value = '';
                fileNameSpan.textContent = 'Pasted Text';
                processNewContent(text, false);
            });

            // --- TTS Implementation ---
            function updatePlayPauseUI() {
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playPauseText.textContent = 'Pause';
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    playPauseText.textContent = 'Play';
                    if (!speechSynthesis.speaking) ttsProgressBar.style.width = '0%';
                }
            }

            function populateVoiceList() {
                voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
                ttsVoiceSelect.innerHTML = '';
                if (voices.length === 0) {
                    ttsVoiceSelect.innerHTML = '<option>No English voices available</option>';
                    return;
                }
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-name', voice.name);
                    ttsVoiceSelect.appendChild(option);
                });
                // Prefer a US voice if available
                const preferredVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Google'));
                if(preferredVoice) ttsVoiceSelect.value = `${preferredVoice.name} (${preferredVoice.lang})`;
            }

            function speak(text, startIndex = 0) {
                speechSynthesis.cancel();
                speechStartIndex = startIndex;
                const textToSpeak = text.substring(startIndex);
                if (!textToSpeak) return;

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                const selectedVoiceName = ttsVoiceSelect.selectedOptions[0]?.getAttribute('data-name');
                utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
                utterance.rate = ttsRateSlider.value;
                utterance.lang = 'en-US'; // Set lang for better pronunciation

                utterance.onboundary = (event) => {
                    const progress = currentRawText.length > 0 ? ((speechStartIndex + event.charIndex) / currentRawText.length) * 100 : 0;
                    ttsProgressBar.style.width = `${progress}%`;
                };
                utterance.onend = () => { updatePlayPauseUI(); };
                utterance.onerror = (event) => { console.error('TTS Error', event); updatePlayPauseUI(); };
                
                speechSynthesis.speak(utterance);
                setTimeout(updatePlayPauseUI, 50);
            }

            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }

            ttsPlayPauseBtn.addEventListener('click', () => {
                if (!currentRawText) return;
                if (speechSynthesis.speaking) {
                    speechSynthesis.paused ? speechSynthesis.resume() : speechSynthesis.pause();
                } else {
                    speak(currentRawText, 0);
                }
                setTimeout(updatePlayPauseUI, 50);
            });

            ttsStopBtn.addEventListener('click', () => {
                speechSynthesis.cancel();
                updatePlayPauseUI();
            });

            ttsRateSlider.addEventListener('input', (e) => {
                const rate = parseFloat(e.target.value);
                ttsRateLabel.textContent = `${rate.toFixed(1)}x`;
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    const progress = parseFloat(ttsProgressBar.style.width) || 0;
                    const seekIndex = Math.floor((progress / 100) * currentRawText.length);
                    speak(currentRawText, seekIndex);
                }
            });

            ttsProgressContainer.addEventListener('click', (e) => {
                if (!currentRawText) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const percentage = (e.clientX - rect.left) / e.currentTarget.offsetWidth;
                let seekIndex = Math.floor(percentage * currentRawText.length);
                const lastSpace = currentRawText.lastIndexOf(' ', seekIndex);
                if (lastSpace !== -1) seekIndex = lastSpace + 1; // Start from the beginning of a word
                speak(currentRawText, seekIndex);
            });
            
            // Toggle visibility of sections
            document.querySelectorAll('.toggle-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.closest('.section-header').nextElementSibling;
                    content.classList.toggle('hidden');
                    button.textContent = content.classList.contains('hidden') ? 'Show' : 'Collapse';
                });
            });

            // Text selection popup logic
            document.addEventListener('mouseup', (e) => {
                setTimeout(async () => {
                    const selection = window.getSelection();
                    const selectedText = selection.toString().trim();
                    if (!selectedText || selection.isCollapsed || selectionPopup.contains(e.target) || modalContentInner.contains(e.target) || e.target.closest('.word-clickable')) {
                        return;
                    }

                    lookupModalOverlay.style.display = 'none';
                    selectionPopup.classList.remove('hidden');
                    selectionPopup.style.visibility = 'hidden';

                    const rect = selection.getRangeAt(0).getBoundingClientRect();
                    selectionPopup.style.top = `${rect.bottom + window.scrollY + 5}px`;
                    selectionPopup.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (selectionPopup.offsetWidth / 2)}px`;
                    selectionPopup.style.visibility = 'visible';
                    
                    selectionTranslateResultDiv.classList.add('hidden');
                    selectionTranslateSpinner.style.display = 'none';

                    copySelectionButton.onclick = () => {
                        navigator.clipboard.writeText(selectedText).then(() => {
                            selectionPopup.classList.add('hidden');
                        });
                    };
                    translateSelectionButton.onclick = async () => {
                        const translation = await getVietnameseTranslation(selectedText);
                        selectionTranslateResultDiv.innerHTML = `<strong>D·ªãch:</strong> ${translation}`;
                        selectionTranslateResultDiv.classList.remove('hidden');
                    };
                }, 0);
            });
        }
        
        window.addEventListener('load', mainApp);

    </script>
</body>
</html>
