<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc ti·∫øng Anh Dichi v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #333; min-height: 100vh; }

        /* Z-Index Strategy */
        #settings-sidebar { transition: transform 0.3s ease-in-out; z-index: 3000; }
        .sidebar-overlay { background-color: rgba(0, 0, 0, 0.5); z-index: 2999; }
        #open-sidebar-btn { z-index: 2900; }

        .container { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 1.5rem; width: 100%; max-width: 900px; margin: 20px auto; overflow: hidden; position: relative; z-index: 1; }

        /* Content Box */
        .text-content {
            white-space: pre-wrap; word-wrap: break-word; line-height: 2.2; margin-top: 1rem; padding: 1rem;
            background-color: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;
            min-height: 150px; max-height: 60vh; overflow-y: auto; font-size: 1.15rem;
        }

        /* Th·∫ª Ruby ƒë·ªÉ hi·ªÉn th·ªã IPA/Phonetic ph√≠a tr√™n t·ª´ */
        .word-clickable, .segmented-word ruby { cursor: pointer; padding: 2px; border-radius: 4px; transition: background-color 0.2s ease; display: inline-flex; flex-direction: column-reverse; align-items: center; line-height: 1.2; }
        .word-clickable:hover, .segmented-word:hover { background-color: #e0e7ff; }
        .segmented-word { border: 1px solid #d1d5db; margin: 2px; }
/* CH·ªàNH S·ª¨A: Vi·ªÅn m·ªù h∆°n cho c·ª•m t·ª´ */
    .segmented-word { 
        border: 1px solid #efeeee; 
        margin: 2px;
        line-height: 1.4; /* TƒÉng kho·∫£ng c√°ch d√≤ng */
    }
    
    /* CH·ªàNH S·ª¨A: IPA to h∆°n, ƒë·∫≠m h∆°n, c√≥ m√†u */
    .segmented-word rt {
        font-size: 0.9rem; 
        font-weight: 600; 
        color: #dc2626; /* M√†u ƒë·ªè */
    }
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.0); z-index: 3100; display: none; }
        .modal-content { background-color: #fefefe; padding: 15px; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); position: absolute; max-width: 280px; z-index: 3200; border: 1px solid #e5e7eb; animation: fadeIn 0.2s ease-out; cursor: grab; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Buttons */
        .button-base { padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .button-base:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-base:hover:not(:disabled) { transform: translateY(-1px); }
        .button-base:active:not(:disabled) { transform: translateY(0); }
        .button-primary { background-color: #4f46e5; color: white; }
        .button-primary:hover:not(:disabled) { background-color: #4338ca; }
        .button-secondary { background-color: #6b7280; color: white; }
        .button-secondary:hover:not(:disabled) { background-color: #4b5563; }
        .button-danger { background-color: #dc2626; color: white; }
        .button-danger:hover:not(:disabled) { background-color: #b91c1c; }

        /* Links */
        a.link-button { display: block; background-color: #eff6ff; color: #1d4ed8; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; text-align: center; text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.9rem; }
        a.link-button:hover { background-color: #dbeafe; color: #1e40af; }
        #reference-section a { color: #2563eb; text-decoration: underline; cursor: pointer; position: relative; z-index: 10; }
        #reference-section a:hover { color: #1e40af; }
        #reference-section ul { list-style-type: disc; padding-left: 25px; }
        #reference-section li { margin-bottom: 0.5rem; }

        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .section-header h3 { font-size: 1.25rem; font-weight: 600; color: #333; margin: 0; }
        .content-section { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 20px; margin-top: 20px; border: 1px solid #e5e7eb; position: relative; }

        .text-selection-popup { max-width: 320px; padding: 10px; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 1px solid #ccc; background-color: #fff; cursor: grab; position: absolute; z-index: 3300; }
        .text-selection-popup .button-secondary, .text-selection-popup .button-primary { padding: 6px 10px; font-size: 0.8rem; width: 100%; }
        .close-button { position: absolute; top: 4px; right: 8px; font-size: 1.5rem; font-weight: bold; color: #9ca3af; cursor: pointer; line-height: 1; padding: 2px; }
        .close-button:hover { color: #374151; }

        .tts-controls { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; background-color: #f9fafb; }
        #tts-progress-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; cursor: pointer; height: 10px; }
        #tts-progress-bar { height: 100%; background-color: #4f46e5; border-radius: 9999px; width: 0%; transition: width 0.1s linear; }
        .resizable-media { resize: vertical; overflow: hidden; min-height: 150px; height: auto; background: #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; }
        .resizable-media video { width: 100%; height: 100%; object-fit: contain; }

        .task-progress-wrapper { width: 100%; margin-top: 8px; display: none; }
        .task-progress-bar-bg { width: 100%; background-color: #e5e7eb; border-radius: 999px; height: 6px; overflow: hidden; }
        .task-progress-bar-fill { height: 100%; background-color: #10b981; width: 0%; transition: width 0.3s ease; }
        .task-status-text { font-size: 0.75rem; color: #6b7280; margin-top: 4px; display: flex; justify-content: space-between; }
        .task-controls { display: flex; gap: 5px; align-items: center; }

        .menu-link { display: block; padding: 8px 12px; color: #4b5563; font-weight: 500; border-radius: 6px; transition: background 0.2s; cursor: pointer; text-decoration: none; }
        .menu-link:hover { background-color: #f3f4f6; color: #4f46e5; }
    </style>
</head>
<body>
    <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 hidden"></div>

    <div id="settings-sidebar" class="fixed top-0 left-0 h-full w-80 sm:w-96 bg-white shadow-2xl transform -translate-x-full overflow-y-auto flex flex-col">
        <div class="p-6 flex-grow">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Menu & C√†i ƒë·∫∑t</h2>
                <button id="close-sidebar" class="text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>

            <div class="mb-6 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wider">M·ª•c l·ª•c</h3>
                <nav class="space-y-1">
                    <a href="#input-section" class="menu-link">üì• Nh·∫≠p li·ªáu & T·∫£i file</a>
                    <a href="#media-player-section" class="menu-link">üé¨ Tr√¨nh ph√°t Media</a>
                    <a href="#tts-section-wrapper" class="menu-link">üîä ƒê·ªçc vƒÉn b·∫£n (TTS)</a>
                    <a href="#main-text-section" class="menu-link">üìÑ VƒÉn b·∫£n g·ªëc</a>
                    <a href="#pinyin-text-section" class="menu-link">üó£Ô∏è Ph√°t √¢m/IPA (AI)</a>
                    <a href="#segmented-text-section" class="menu-link">‚úÇÔ∏è T√°ch t·ª´ (AI)</a>
                    <a href="#full-translation-section" class="menu-link">üáªüá≥ B·∫£n d·ªãch (AI)</a>
                    <a href="#explanation-section" class="menu-link">üéì Gi·∫£i th√≠ch chi ti·∫øt (AI)</a>
                    <a href="#ai-tools-section" class="menu-link">ü§ñ C√¥ng c·ª• t·ª´ v·ª±ng AI</a>
                </nav>
            </div>

            <div class="mb-6 border-b pb-4">
                <h3 class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wider">C·∫•u h√¨nh API</h3>
                <div class="mb-3">
                    <label class="block mb-1 text-sm font-medium text-gray-700">Nh√† cung c·∫•p:</label>
                    <select id="ai-provider-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                        <option value="gemini">Google Gemini (Free)</option>
                        <option value="deepseek">DeepSeek (Paid)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block mb-1 text-sm font-medium text-gray-700">API Key:</label>
                    <input type="password" id="api-key-input" placeholder="Nh·∫≠p API Key..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm mb-2">
                    <button id="save-api-key-button" class="button-base button-primary w-full">L∆∞u API Key</button>
                </div>
                <p id="api-key-guide" class="text-xs text-gray-500 mb-1"></p>
                <p id="api-key-status" class="text-sm text-green-600 font-medium h-5"></p>
                <div class="mt-2 grid grid-cols-2 gap-2">
                    <div><label class="block mb-1 text-sm font-medium text-gray-700">ƒê·ªô tr·ªÖ (s):</label><input type="number" id="delay-input" value="5" min="0" step="0.5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></div>
                    <div><label class="block mb-1 text-sm font-medium text-gray-700">Chunk Size:</label><input type="number" id="chunk-size-input" value="100" min="10" max="1000" step="10" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm"></div>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-3"><h3 class="font-semibold text-gray-700 text-sm uppercase tracking-wider">Prompt T√πy ch·ªânh</h3><button id="reset-prompts-btn" class="text-xs text-red-500 underline">Reset</button></div>
                <div class="space-y-3">
                    <div><label class="text-xs font-medium text-gray-600">Ph√°t √¢m/IPA:</label><textarea id="prompt-pinyin" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                    <div><label class="text-xs font-medium text-gray-600">T√°ch t·ª´:</label><textarea id="prompt-segment" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                    <div><label class="text-xs font-medium text-gray-600">Gi·∫£i th√≠ch:</label><textarea id="prompt-explain" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                    <div><label class="text-xs font-medium text-gray-600">D·ªãch:</label><textarea id="prompt-translate" rows="3" class="w-full p-2 border text-xs bg-gray-50 rounded"></textarea></div>
                </div>
            </div>
        </div>
    </div>

    <button id="open-sidebar-btn" class="fixed top-4 left-4 z-50 bg-white p-2 rounded-full shadow-lg border border-gray-200 hover:bg-gray-100 text-gray-700" title="M·ªü c√†i ƒë·∫∑t"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>

    <div class="container">
        <div class="flex justify-between items-start mb-6 pl-12">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">H·ªçc ti·∫øng Anh c√πng Dichi</h1>
            <img src="kieuoanh.jpg" alt="<3" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover border-2 border-white shadow-lg flex-shrink-0" onerror="this.style.display='none'">
        </div>

        <div id="input-section" class="content-section !mt-0">
            <div class="section-header">
                <h3>üì• Nh·∫≠p li·ªáu & T·∫£i file</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="input-content-wrapper">Thu g·ªçn</button>
            </div>
            <div id="input-content-wrapper">
                <div class="space-y-4 mb-4">
                    <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                        <div class="flex items-center space-x-2">
                            <label for="file-upload" class="button-base button-secondary cursor-pointer">T·∫£i l√™n t·ªáp tin .docx</label>
                            <input type="file" id="file-upload" class="hidden" accept=".txt,.docx,.DOCX">
                            <span id="file-name" class="text-gray-600 text-sm"></span>
                        </div>
                    </div>
                    <div class="mt-2 flex flex-col sm:flex-row items-center justify-center gap-2">
                        <input type="url" id="url-input" class="w-full sm:w-auto flex-grow p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="Ho·∫∑c d√°n URL...">
                        <button id="fetch-url-button" class="button-base button-primary w-full sm:w-auto">T·∫£i URL</button>
                    </div>
                    <div class="mt-2">
                        <label class="block mb-2 text-sm font-medium text-gray-700">VƒÉn b·∫£n tr·ª±c ti·∫øp:</label>
                        <textarea id="text-input-area" rows="5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="D√°n vƒÉn b·∫£n ti·∫øng Anh v√†o ƒë√¢y..."></textarea>
                        <button id="process-text-button" class="button-base button-primary mt-2">X·ª≠ l√Ω vƒÉn b·∫£n</button>
                    </div>
                    <div class="flex flex-wrap items-center justify-center gap-4 pt-4">
                        <button id="pinyin-button" class="button-base button-secondary">Th√™m Ph√°t √¢m</button>
                        <button id="segment-text-button" class="button-base button-secondary">T√°ch c·ª•m t·ª´</button>
                        <button id="explain-text-button" class="button-base button-secondary">Gi·∫£i th√≠ch</button>
                        <button id="translate-full-text-button" class="button-base button-secondary">D·ªãch vƒÉn b·∫£n</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="media-player-section" class="content-section">
            <div class="section-header">
                <h3>üé¨ Tr√¨nh ph√°t Media</h3>
                <div><label for="media-upload" class="button-base button-primary text-xs px-3 py-1 mr-2 cursor-pointer">T·∫£i file</label><input type="file" id="media-upload" class="hidden" accept="audio/*,video/*"><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="media-container">Thu g·ªçn</button></div>
            </div>
            <div id="media-container" class="hidden">
                <div class="resizable-media mb-3" id="video-wrapper"><video id="main-media-player" controls style="display:none;"></video></div>
                <audio id="main-audio-player" controls class="w-full" style="display:none;"></audio>
                <p id="media-filename" class="text-sm text-center text-gray-500 mb-2 italic">Ch∆∞a c√≥ file.</p>
                <div id="media-controls" class="flex flex-wrap justify-center items-center gap-3 p-2 bg-gray-50 rounded border border-gray-200 opacity-50 pointer-events-none">
                    <button id="media-rewind" class="button-base button-secondary text-xs">-10s</button>
                    <button id="media-forward" class="button-base button-secondary text-xs">+10s</button>
                    <div class="flex items-center space-x-2 ml-2 border-l pl-3 border-gray-300"><label class="text-xs font-medium">T·ªëc ƒë·ªô:</label><select id="media-rate" class="p-1 border border-gray-300 rounded text-xs"><option value="0.5">0.5x</option><option value="1" selected>1.0x</option><option value="1.5">1.5x</option><option value="2">2.0x</option></select></div>
                </div>
            </div>
        </div>

        <div id="tts-section-wrapper" class="content-section">
             <div class="section-header">
                <h3>üîä C√¥ng c·ª• ƒë·ªçc vƒÉn b·∫£n (TTS)</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="tts-inner-content">Thu g·ªçn</button>
            </div>
            <div id="tts-inner-content" class="tts-controls space-y-3">
                <div class="flex items-center gap-4">
                    <button id="tts-play-pause" class="button-base button-primary flex items-center justify-center w-28">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1zm6 0a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span id="play-pause-text" class="ml-2">Ph√°t</span>
                    </button>
                    <button id="tts-stop" class="button-base button-secondary">D·ª´ng</button>
                    <div id="tts-progress-container" class="flex-grow"><div id="tts-progress-bar"></div></div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <div class="flex items-center space-x-2"><label class="text-sm font-medium">Gi·ªçng:</label><select id="tts-voice" class="p-2 border border-gray-300 rounded-md shadow-sm text-sm"></select></div>
                    <div class="flex items-center space-x-2"><label class="text-sm font-medium">T·ªëc ƒë·ªô:</label><input type="range" id="tts-rate" min="0.5" max="2" value="1" step="0.1" class="w-24"><span id="tts-rate-label" class="text-sm font-mono">1.0x</span></div>
                    <div class="flex items-center space-x-2"><input type="checkbox" id="auto-play-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label class="text-sm font-medium">Auto ph√°t</label></div>
                </div>
            </div>
        </div>

        <div id="main-text-section" class="content-section">
            <div class="section-header"><h3>üìÑ VƒÉn b·∫£n g·ªëc</h3><div><button id="copy-main-text-button" class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2" data-target="text-display">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="text-display">Thu g·ªçn</button></div></div>
            <div id="text-display" class="text-content">Vui l√≤ng t·∫£i l√™n m·ªôt t·ªáp tin ho·∫∑c nh·∫≠p vƒÉn b·∫£n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
        </div>

        <div id="pinyin-text-section" class="content-section hidden">
            <div class="section-header"><h3>üó£Ô∏è VƒÉn b·∫£n v·ªõi Ph√°t √¢m/IPA (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="pinyin-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="pinyin-content">Thu g·ªçn</button><button id="stop-pinyin" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-pinyin" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="pinyin-content" class="text-gray-700 text-content section-content"></div>
        </div>
        <div id="segmented-text-section" class="content-section hidden">
            <div class="section-header"><h3>‚úÇÔ∏è VƒÉn b·∫£n theo c·ª•m t·ª´ (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="segmented-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="segmented-content">Thu g·ªçn</button><button id="stop-segment" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-segment" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="segmented-content" class="text-gray-700 text-content section-content"></div>
        </div>
        <div id="full-translation-section" class="content-section hidden">
            <div class="section-header"><h3>üáªüá≥ B·∫£n d·ªãch (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="full-translation-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="full-translation-content">Thu g·ªçn</button><button id="stop-translate" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-translate" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="full-translation-content" class="text-gray-700 text-content section-content"></div>
        </div>
        <div id="explanation-section" class="content-section hidden">
            <div class="section-header"><h3>üéì Gi·∫£i th√≠ch n·ªôi dung (AI)</h3><div class="task-controls"><button class="copy-button button-base button-secondary text-xs px-2 py-1" data-target="explanation-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="explanation-content">Thu g·ªçn</button><button id="stop-explain" class="button-base button-danger text-xs px-2 py-1 hidden">D·ª´ng</button></div></div>
            <div id="progress-explain" class="task-progress-wrapper"><div class="task-progress-bar-bg"><div class="task-progress-bar-fill"></div></div><div class="task-status-text"><span>ƒêang x·ª≠ l√Ω...</span><span>0%</span></div></div>
            <div id="explanation-content" class="text-gray-700 text-content section-content"></div>
        </div>

        <div id="ai-tools-section" class="mt-8 content-section">
            <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">ü§ñ C√¥ng c·ª• AI</h3>
            <div class="flex items-center gap-2"><input type="text" id="ai-custom-input" placeholder="Nh·∫≠p t·ª´ ho·∫∑c c·ª•m t·ª´..." class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full"></div>
            <div class="flex items-center justify-center gap-2 mt-2">
                <button id="ai-generate-sentence-button" class="button-base button-primary">T·∫°o c√¢u v√≠ d·ª•</button>
                <button id="ai-generate-related-words-button" class="button-base button-primary">T·∫°o t·ª´ li√™n quan</button>
            </div>
            <div id="loading-spinner" class="loading-spinner"></div>
            <div id="ai-sentence-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden"><div class="section-header"><h3>C√¢u v√≠ d·ª•</h3><div><button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2" data-target="ai-sentence-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="ai-sentence-content">Thu g·ªçn</button></div></div><div id="ai-sentence-content" class="section-content text-left"></div></div>
            <div id="ai-related-words-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden"><div class="section-header"><h3>T·ª´ li√™n quan</h3><div><button class="copy-button button-base button-secondary text-xs px-2 py-1 mr-2" data-target="ai-related-words-content">Sao ch√©p</button><button class="toggle-button button-base button-secondary text-xs px-2 py-1" data-target="ai-related-words-content">Thu g·ªçn</button></div></div><div id="ai-related-words-content" class="section-content text-left"></div></div>
        </div>

        <div id="reference-section" class="content-section">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">Trang web tham kh·∫£o</h3>
            <ul>
                <li><a id="cambridge-link-ref" href="https://dictionary.cambridge.org/dictionary/english/" target="_blank">Cambridge Dictionary</a> - T·ª´ ƒëi·ªÉn Anh-Anh, Anh-Vi·ªát, c√≥ ph√°t √¢m v√† IPA.</li>
                <li><a id="youglish-link-ref" href="https://youglish.com/pronounce//english" target="_blank">YouGlish</a> - Ph√°t √¢m trong ng·ªØ c·∫£nh qua video YouTube.</li>
                <li><a id="vtudien-link-ref" href="https://vtudien.com/anh-viet" target="_blank">Vtudien.com</a> - T·ª´ ƒëi·ªÉn Anh-Vi·ªát.</li>
                <!-- <li>* Web n√†y ƒë∆∞·ª£c t·∫∑ng cho <a href="https://www.facebook.com/kieuoanhdichi" target="_blank">Ki·ªÅu Oanh</a> - Gi√°o vi√™n ti·∫øng Anh.</li> -->
            </ul>
        </div>

        <div id="text-stats-section" class="hidden content-section">
             <h3 class="text-xl font-semibold mb-3 text-gray-800">Th·ªëng k√™</h3>
             <p class="text-sm text-gray-600">ƒê·ªô d√†i: <span id="char-count" class="font-bold">0</span> k√Ω t·ª±</p>
             <p class="text-sm text-gray-600">S·ªë t·ª´: <span id="word-count" class="font-bold">0</span> t·ª´</p>
        </div>

        <div id="lookup-modal" class="modal-overlay">
            <div id="modal-content-inner" class="modal-content">
                <button id="close-lookup-modal" class="close-button">&times;</button>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Tra: <span id="selected-word-modal" class="font-bold text-indigo-600"></span></h2>
                <div class="flex items-center gap-2 mt-2 mb-3"><button id="pronounce-word-button" class="button-base button-primary flex-1">Ph√°t √¢m</button><button id="copy-word-button" class="button-base button-secondary flex-1">Sao ch√©p</button></div>
                <div class="space-y-2">
                    <a id="cambridge-link-modal" href="#" target="_blank" class="link-button">Cambridge</a>
                    <a id="youglish-link-modal" href="#" target="_blank" class="link-button">YouGlish</a>
                    <a id="vtudien-link-modal" href="#" target="_blank" class="link-button">Vtudien</a>
                </div>
                <div id="google-translate-result" class="mt-4"></div>
                <div id="translate-loading-spinner" class="loading-spinner"></div>
            </div>
        </div>
        <div id="selection-popup" class="modal-content text-selection-popup hidden">
            <button id="close-selection-popup" class="close-button">&times;</button>
            <div class="flex flex-col space-y-2">
                <button id="copy-selection-button" class="button-base button-secondary w-full">Sao ch√©p</button>
                <button id="translate-selection-button" class="button-base button-primary w-full">D·ªãch</button>
                <button id="pronounce-selection-button" class="button-base button-primary w-full">Ph√°t √¢m</button>
                <a id="cambridge-selection-link" href="#" target="_blank" class="link-button">Tra Cambridge</a>
            </div>
            <div id="selection-translate-result" class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-gray-700 text-sm hidden"></div>
            <div id="selection-translate-spinner" class="loading-spinner"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        function mainApp() {
            // 1. DEFINITIONS (Hoisted Helpers)
            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.textContent = message;
                notification.style.position = 'fixed'; notification.style.bottom = '20px'; notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)'; notification.style.padding = '10px 20px';
                notification.style.borderRadius = '8px'; notification.style.color = 'white';
                notification.style.backgroundColor = type === 'success' ? '#4f46e5' : '#dc2626';
                notification.style.zIndex = '3500';
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease'; document.body.appendChild(notification);
                setTimeout(() => { notification.style.opacity = '1'; }, 10);
                setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 300); }, 3000);
            }

            function copyToClipboard(text) {
                if (!text) return;
                const textArea = document.createElement("textarea"); textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.top = "-9999px"; document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); showNotification('ƒê√£ sao ch√©p!'); } catch (err) { showNotification('L·ªói sao ch√©p!', 'error'); }
                document.body.removeChild(textArea);
            }

            function copyHtmlToClipboard(element) {
                if (!element) return;
                if (typeof element === 'string') { copyToClipboard(element); return; }
                const range = document.createRange();
                range.selectNode(element);
                window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
                try { document.execCommand('copy'); showNotification('ƒê√£ sao ch√©p!'); } catch (err) { showNotification('L·ªói sao ch√©p!', 'error'); }
                window.getSelection().removeAllRanges();
            }

            // K√≠ch ho·∫°t k√©o di chuy·ªÉn cho c√°c popup
            function makeDraggable(element) {
                let isDragging = false, initialMouseX, initialMouseY, initialElementLeft, initialElementTop;
                element.addEventListener("mousedown", (e) => {
                    // Tr√°nh k√©o khi click v√†o n√∫t ho·∫∑c link
                    if (e.target.closest('a, button, .close-button')) return;
                    isDragging = true; element.style.cursor = 'grabbing'; element.style.zIndex = 3301;
                    
                    const rect = element.getBoundingClientRect(); 
                    initialElementLeft = rect.left; 
                    initialElementTop = rect.top; 
                    initialMouseX = e.clientX; 
                    initialMouseY = e.clientY; 
                    
                    element.style.position = 'fixed'; 
                    e.preventDefault(); e.stopPropagation();
                });
                document.addEventListener("mousemove", (e) => { 
                    if (isDragging) { 
                        e.preventDefault(); 
                        element.style.left = `${initialElementLeft + e.clientX - initialMouseX}px`; 
                        element.style.top = `${initialElementTop + e.clientY - initialMouseY}px`; 
                    } 
                });
                document.addEventListener("mouseup", () => { 
                    if (isDragging) { 
                        isDragging = false; 
                        element.style.cursor = 'grab'; 
                        element.style.zIndex = 3200; 
                    } 
                });
            }

            let activeMediaPlayer = null;
            let voices = [];
            const ttsVoiceSelect = document.getElementById('tts-voice');
            const ttsRateSlider = document.getElementById('tts-rate');

let isSpeaking = false;
let ttsUtterance = null;

function startTtsPlayback() {
    // L·∫•y vƒÉn b·∫£n t·ª´ v√πng hi·ªÉn th·ªã g·ªëc
    const textToSpeak = currentRawText.trim(); 

    if (!textToSpeak) {
        showNotification("VƒÉn b·∫£n g·ªëc r·ªóng!", "error");
        return;
    }

    if (isSpeaking) {
        // N·∫øu ƒëang n√≥i, t·∫°m d·ª´ng
        speechSynthesis.pause();
        isSpeaking = false;
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        playPauseText.textContent = 'Ph√°t';
        return;
    } 
    
    if (speechSynthesis.paused) {
        // N·∫øu ƒëang t·∫°m d·ª´ng, ti·∫øp t·ª•c
        speechSynthesis.resume();
        isSpeaking = true;
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        playPauseText.textContent = 'T·∫°m d·ª´ng';
        return;
    }

    // Kh·ªüi t·∫°o Utterance m·ªõi
    speechSynthesis.cancel(); // ƒê·∫£m b·∫£o h·ªßy b·ªè m·ªçi gi·ªçng n√≥i tr∆∞·ªõc ƒë√≥
    ttsUtterance = new SpeechSynthesisUtterance(textToSpeak);

    // G·∫Øn gi·ªçng n√≥i v√† t·ªëc ƒë·ªô
    const selectedName = ttsVoiceSelect.value;
    const selectedVoice = speechSynthesis.getVoices().find(v => v.name === selectedName);
    if(selectedVoice) {
        ttsUtterance.voice = selectedVoice;
    }
    ttsUtterance.rate = parseFloat(ttsRateSlider.value);
    ttsUtterance.lang = 'en-US';

    // Thi·∫øt l·∫≠p tr·∫°ng th√°i khi ho√†n th√†nh
    ttsUtterance.onend = () => {
        isSpeaking = false;
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        playPauseText.textContent = 'Ph√°t';
        ttsProgressBar.style.width = '100%';
        setTimeout(() => ttsProgressBar.style.width = '0%', 500);
    };

    // Theo d√µi ti·∫øn tr√¨nh (T√πy ch·ªçn, ƒë·ªÉ thanh progress bar ch·∫°y)
    const updateProgress = setInterval(() => {
        if (!isSpeaking || !ttsUtterance) {
            clearInterval(updateProgress);
            return;
        }
        // L∆∞u √Ω: Web Speech API kh√¥ng cung c·∫•p th·ªùi gian th·ª±c cho vƒÉn b·∫£n d√†i,
        // n√™n ch√∫ng ta s·∫Ω ∆∞·ªõc t√≠nh ti·∫øn tr√¨nh d·ª±a tr√™n th·ªùi gian.
        // ƒê√¢y l√† gi·∫£i ph√°p ƒë∆°n gi·∫£n thay th·∫ø:
        // ttsProgressBar.style.width = `${(speechSynthesis.currentTime / totalDuration) * 100}%`;
    }, 100);

    // B·∫Øt ƒë·∫ßu ph√°t
    speechSynthesis.speak(ttsUtterance);
    isSpeaking = true;
    playIcon.classList.add('hidden');
    pauseIcon.classList.remove('hidden');
    playPauseText.textContent = 'T·∫°m d·ª´ng';
}

function stopTtsPlayback() {
    speechSynthesis.cancel();
    isSpeaking = false;
    playIcon.classList.remove('hidden');
    pauseIcon.classList.add('hidden'); // Pause icon (d·ª´ng)
    playPauseText.textContent = 'Ph√°t';
    ttsProgressBar.style.width = '0%';
}

let voiceLoadTimeout;

function populateVoiceList() {
    clearTimeout(voiceLoadTimeout); // X√≥a timeout c≈© n·∫øu c√≥

    voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
    
    ttsVoiceSelect.innerHTML = '';
    
    if (voices.length === 0) {
        const allVoices = speechSynthesis.getVoices();
        if(allVoices.length > 0) {
            allVoices.forEach(v => ttsVoiceSelect.appendChild(new Option(`${v.name} (${v.lang})`, v.name)));
        } else {
            ttsVoiceSelect.appendChild(new Option('ƒêang t·∫£i gi·ªçng...', ''));
            // ƒê·∫∑t timeout ƒë·ªÉ th·ª≠ l·∫°i n·∫øu danh s√°ch gi·ªçng n√≥i ch∆∞a s·∫µn s√†ng
            voiceLoadTimeout = setTimeout(populateVoiceList, 500); 
            return;
        }
    } else {
        voices.forEach(v => ttsVoiceSelect.appendChild(new Option(`${v.name} (${v.lang})`, v.name)));
    }
    
    // Th√™m l·ª±a ch·ªçn gi·ªçng m·∫∑c ƒë·ªãnh n·∫øu danh s√°ch kh√¥ng r·ªóng
    if (ttsVoiceSelect.options.length > 0 && !ttsVoiceSelect.value) {
        const defaultVoice = voices.find(v => v.lang === 'en-US' || v.lang === 'en-GB') || voices[0];
        if (defaultVoice) {
            ttsVoiceSelect.value = defaultVoice.name;
        } else {
            ttsVoiceSelect.value = ttsVoiceSelect.options[0].value;
        }
    }
}
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
            setTimeout(populateVoiceList, 1000); // Th·ª≠ l·∫°i sau 1 gi√¢y

function speakWord(text) {
    if(activeMediaPlayer && !activeMediaPlayer.paused) activeMediaPlayer.pause();
    if (!text) return;

    // C·∫≠p nh·∫≠t danh s√°ch gi·ªçng n√≥i ngay tr∆∞·ªõc khi ph√°t ƒë·ªÉ c√≥ d·ªØ li·ªáu m·ªõi nh·∫•t
    populateVoiceList(); 
    
    // ƒê·∫£m b·∫£o h·ªßy b·ªè TTS to√†n vƒÉn b·∫£n n·∫øu ƒëang ch·∫°y
    if (isSpeaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        playPauseText.textContent = 'Ph√°t';
        ttsProgressBar.style.width = '0%';
    }
    
    // Logic ph√°t √¢m t·ª´
    speechSynthesis.cancel(); // H·ªßy b·ªè ngay tr∆∞·ªõc khi g·ªçi Utterance m·ªõi
    const u = new SpeechSynthesisUtterance(text);
    
    const selectedName = ttsVoiceSelect.value;
    // L·∫•y ƒë·ªëi t∆∞·ª£ng gi·ªçng n√≥i t·ª´ danh s√°ch voices (ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t)
    const selectedVoice = voices.find(v => v.name === selectedName); 
    
    if(selectedVoice) { 
        u.voice = selectedVoice; 
    } else {
        u.lang = 'en-US'; 
    }

    u.rate = ttsRateSlider.value;
    u.lang = 'en-US'; 
    speechSynthesis.speak(u);
}
// 2. CONSTANTS (UPDATED PROMPTS FOR STRICT JSON OUTPUT)
            const DEFAULT_PROMPTS = {
                // T·ªëi ∆∞u prompt ƒë·ªÉ gi·∫£m thi·ªÉu l·ªói JSON Parse v√† ƒë·∫£m b·∫£o IPA chu·∫©n
                pinyin: `Ph√¢n t√≠ch ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Anh sau th√†nh t·ª´ng t·ª´ m·ªôt.
B·∫ÆT BU·ªòC ch·ªâ tr·∫£ v·ªÅ JSON m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng. M·ªói ƒë·ªëi t∆∞·ª£ng g·ªìm "word" (t·ª´ ti·∫øng Anh) v√† "phonetic" (c√°ch ƒë·ªçc, IPA).
QUAN TR·ªåNG: V·ªõi m·ªói t·ª´, "phonetic" KH√îNG ƒê∆Ø·ª¢C ƒê·ªÇ TR·ªêNG v√† ph·∫£i l√† phi√™n √¢m IPA chu·∫©n qu·ªëc t·∫ø (v√≠ d·ª•: 'this' -> '√∞…™s').
V·ªõi d·∫•u c√¢u ho·∫∑c k√Ω t·ª± xu·ªëng d√≤ng (\\n), "phonetic" l√† chu·ªói r·ªóng.
V√≠ d·ª• chu·∫©n: 'Hello world.' -> [{"word": "Hello", "phonetic": "h…ôÀàl…ô ä"}, {"word": "world", "phonetic": "w…úÀêld"}, {"word": ".", "phonetic": ""}]
ƒê√¢y l√† vƒÉn b·∫£n:\n\n{{TEXT}}`,
                
                // T·ªëi ∆∞u prompt ƒë·ªÉ gi·∫£m thi·ªÉu l·ªói JSON Parse v√† ƒë·∫£m b·∫£o IPA chu·∫©n
                segment: `Ph√¢n ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Anh sau th√†nh c√°c t·ª´/c·ª•m t·ª´ c√≥ nghƒ©a (tokens), d·∫•u c√¢u, v√† k√Ω t·ª± xu·ªëng d√≤ng, k√®m theo Ph√°t √¢m (phonetic/IPA) cho m·ªói t·ª´/c·ª•m t·ª´.
B·∫ÆT BU·ªòC ch·ªâ tr·∫£ v·ªÅ JSON m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ thu·ªôc t√≠nh "word" v√† "phonetic".
QUAN TR·ªåNG: "phonetic" ph·∫£i l√† phi√™n √¢m IPA chu·∫©n qu·ªëc t·∫ø.
ƒê·ªëi v·ªõi d·∫•u c√¢u ho·∫∑c k√Ω t·ª± xu·ªëng d√≤ng (\\n), "phonetic" s·∫Ω l√† m·ªôt chu·ªói r·ªóng.
V√≠ d·ª•: 'The quick brown fox.' -> [{"word":"The","phonetic":"√∞…ô"},{"word":"quick brown","phonetic":"kw…™k bra än"},{"word":"fox","phonetic":"f…íks"},{"word":".","phonetic":""}].\n\n{{TEXT}}`,
                
                explain: `Gi·∫£i th√≠ch n·ªôi dung ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Anh sau b·∫±ng TI·∫æNG VI·ªÜT.
Y√™u c·∫ßu: 1. Chia theo t·ª´ng c√¢u (g·ªìm t·ª´ ti·∫øng Anh, Ph√°t √¢m, Nghƒ©a Vi·ªát). 2. Ph√¢n t√≠ch ng·ªØ ph√°p v√† t·ª´ v·ª±ng quan tr·ªçng trong m·ªói c√¢u. 3. N·∫øu ƒëo·∫°n vƒÉn l√† ti√™u ƒë·ªÅ ho·∫∑c r·∫•t ng·∫Øn, h√£y gi·∫£i th√≠ch √Ω nghƒ©a c·ªßa ti√™u ƒë·ªÅ ƒë√≥.
KH√îNG d√πng ti·∫øng Anh trong ph·∫ßn gi·∫£i th√≠ch.
VƒÉn b·∫£n:\n\n{{TEXT}}`,
                
                translate: `D·ªãch ƒëo·∫°n vƒÉn b·∫£n ti·∫øng Anh sau sang TI·∫æNG VI·ªÜT chu·∫©n.
Ch·ªâ tr·∫£ v·ªÅ n·ªôi dung b·∫£n d·ªãch, kh√¥ng th√™m l·ªùi d·∫´n ho·∫∑c th√¥ng tin kh√¥ng li√™n quan.
VƒÉn b·∫£n:\n\n{{TEXT}}`
            };

            // 3. SIDEBAR & INIT
            const sidebar = document.getElementById('settings-sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const navLinks = document.querySelectorAll('.menu-link');
            if(openSidebarBtn) {
                openSidebarBtn.addEventListener('click', () => { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); });
                closeSidebarBtn.addEventListener('click', closeSidebar);
                sidebarOverlay.addEventListener('click', closeSidebar);
                navLinks.forEach(link => link.addEventListener('click', closeSidebar));
            }
            function closeSidebar() { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); }

            // 4. DOM ELEMENTS 
            const textDisplay = document.getElementById('text-display');
            const delayInput = document.getElementById('delay-input');
            const chunkSizeInput = document.getElementById('chunk-size-input');
            const urlInput = document.getElementById('url-input');
            const fetchUrlButton = document.getElementById('fetch-url-button');
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameSpan = document.getElementById('file-name');
            const textInputArea = document.getElementById('text-input-area');
            const processTextButton = document.getElementById('process-text-button');
            
            // Stats
            const textStatsSection = document.getElementById('text-stats-section');
            const charCountSpan = document.getElementById('char-count');
            const wordCountSpan = document.getElementById('word-count');
            const copyMainTextButton = document.getElementById('copy-main-text-button');
            
            // Settings & Prompts
            const aiProviderSelect = document.getElementById('ai-provider-select');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyButton = document.getElementById('save-api-key-button');
            const apiKeyGuide = document.getElementById('api-key-guide');
            const apiKeyStatus = document.getElementById('api-key-status');
            const prompts = {
                pinyin: document.getElementById('prompt-pinyin'),
                segment: document.getElementById('prompt-segment'),
                explain: document.getElementById('prompt-explain'),
                translate: document.getElementById('prompt-translate')
            };
            const resetPromptsBtn = document.getElementById('reset-prompts-btn');

            // Media
            const mediaUploadInput = document.getElementById('media-upload');
            const mediaContainer = document.getElementById('media-container');
            const mainVideoPlayer = document.getElementById('main-media-player');
            const mainAudioPlayer = document.getElementById('main-audio-player');
            const mediaFilename = document.getElementById('media-filename');
            const mediaControls = document.getElementById('media-controls');
            const mediaRewindBtn = document.getElementById('media-rewind');
            const mediaForwardBtn = document.getElementById('media-forward');
            const mediaRateSelect = document.getElementById('media-rate');
            
            // TTS
            
            const ttsPlayPauseBtn = document.getElementById('tts-play-pause').addEventListener('click', startTtsPlayback);
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const playPauseText = document.getElementById('play-pause-text');
            const ttsStopBtn = document.getElementById('tts-stop').addEventListener('click', stopTtsPlayback);
            const ttsProgressContainer = document.getElementById('tts-progress-container');
            const ttsProgressBar = document.getElementById('tts-progress-bar');
            const autoPlayToggle = document.getElementById('auto-play-toggle');

            // Popups
            const lookupModalOverlay = document.getElementById('lookup-modal');
            const modalContentInner = document.getElementById('modal-content-inner');
            const selectedWordModalSpan = document.getElementById('selected-word-modal');
            const googleTranslateResultDiv = document.getElementById('google-translate-result');
            const translateLoadingSpinner = document.getElementById('translate-loading-spinner');
            const closeLookupModalBtn = document.getElementById('close-lookup-modal');
            const pronounceWordButton = document.getElementById('pronounce-word-button');
            const copyWordButton = document.getElementById('copy-word-button');
            const selectionPopup = document.getElementById('selection-popup');
            const closeSelectionPopupBtn = document.getElementById('close-selection-popup');
            const copySelectionButton = document.getElementById('copy-selection-button');
            const translateSelectionButton = document.getElementById('translate-selection-button');
            const pronounceSelectionButton = document.getElementById('pronounce-selection-button');
            const cambridgeSelectionLink = document.getElementById('cambridge-selection-link');
            const selectionTranslateResultDiv = document.getElementById('selection-translate-result');
            const selectionTranslateSpinner = document.getElementById('selection-translate-spinner');
            
            // AI Tools
            const aiCustomInput = document.getElementById('ai-custom-input');
            let currentRawText = '';
            let requestQueue = [];
            let isRequestLoopRunning = false;
            let speechStartIndex = 0;

            // K√≠ch ho·∫°t k√©o th·∫£ cho c√°c popup
            makeDraggable(modalContentInner);
            makeDraggable(selectionPopup);

            // 5. LOGIC & TASKS
            // Load Prompts immediately
            function loadPrompts() {
                prompts.pinyin.value = localStorage.getItem('promptPinyin') || DEFAULT_PROMPTS.pinyin;
                prompts.segment.value = localStorage.getItem('promptSegment') || DEFAULT_PROMPTS.segment;
                prompts.explain.value = localStorage.getItem('promptExplain') || DEFAULT_PROMPTS.explain;
                prompts.translate.value = localStorage.getItem('promptTranslate') || DEFAULT_PROMPTS.translate;
            }
            loadPrompts();

            // Tasks Registry
            const tasks = {
                pinyin: { active: false, currentIndex: 0, queue: [], container: document.getElementById('pinyin-content'), section: document.getElementById('pinyin-text-section'), processor: processPhoneticsChunk, stopBtn: document.getElementById('stop-pinyin'), progressDiv: document.getElementById('progress-pinyin') },
                segment: { active: false, currentIndex: 0, queue: [], container: document.getElementById('segmented-content'), section: document.getElementById('segmented-text-section'), processor: processSegmentationChunk, stopBtn: document.getElementById('stop-segment'), progressDiv: document.getElementById('progress-segment') },
                explain: { active: false, currentIndex: 0, queue: [], container: document.getElementById('explanation-content'), section: document.getElementById('explanation-section'), processor: processExplanationChunk, stopBtn: document.getElementById('stop-explain'), progressDiv: document.getElementById('progress-explain') },
                translate: { active: false, currentIndex: 0, queue: [], container: document.getElementById('full-translation-content'), section: document.getElementById('full-translation-section'), processor: processTranslationChunk, stopBtn: document.getElementById('stop-translate'), progressDiv: document.getElementById('progress-translate') }
            };

            async function processRequestQueue() {
                if (isRequestLoopRunning) return;
                isRequestLoopRunning = true;
                while (requestQueue.length > 0) {
                    const job = requestQueue.shift();
                    const task = tasks[job.taskKey];
                    if (!task.active) continue;

                    updateTaskStatus(job.taskKey, "ƒêang x·ª≠ l√Ω...");
                    try {
                        await job.processor(job.chunk, task.container, null, job.index);
                        task.currentIndex++;
                        if (task.active && task.currentIndex < task.queue.length) scheduleNextChunk(job.taskKey);
                        else if (task.currentIndex >= task.queue.length) finishTask(job.taskKey);
                    } catch (error) {
                        console.error(error);
                        task.container.innerHTML += `<p class="text-red-500">L·ªói: ${error.message}</p>`;
                    }
                    const delay = (parseFloat(delayInput.value) || 5) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
                isRequestLoopRunning = false;
            }

            function scheduleNextChunk(taskKey) {
                const task = tasks[taskKey];
                if(!task.active || task.currentIndex >= task.queue.length) return;
                requestQueue.push({ taskKey: taskKey, chunk: task.queue[task.currentIndex], index: task.currentIndex, processor: task.processor });
                updateTaskStatus(taskKey, "ƒêang ƒë·ª£i...");
                processRequestQueue();
            }

            function startTask(taskKey) {
                // L√†m s·∫°ch vƒÉn b·∫£n th√¥ tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu t√°c v·ª•
                if(!currentRawText || !currentRawText.trim()) { 
                    showNotification("Vui l√≤ng nh·∫≠p vƒÉn b·∫£n ti·∫øng Anh", "error"); 
                    return; 
                }
                const task = tasks[taskKey];
                task.section.classList.remove('hidden');
                task.stopBtn.classList.remove('hidden');
                task.progressDiv.style.display = 'block';
                task.active = true;

                if(task.queue.length === 0 || task.currentIndex >= task.queue.length) {
                    task.container.innerHTML = '';
                    const size = parseInt(chunkSizeInput.value) || 100;
                    // S·ª≠ d·ª•ng h√†m chunkText m·ªõi ƒë·ªÉ gi·ªØ nguy√™n ranh gi·ªõi ƒëo·∫°n
                    task.queue = chunkText(currentRawText, size); 
                    task.currentIndex = 0;
                }
                scheduleNextChunk(taskKey);
            }

            function stopTask(taskKey) {
                tasks[taskKey].active = false;
                tasks[taskKey].stopBtn.classList.add('hidden');
                updateTaskStatus(taskKey, "ƒê√£ d·ª´ng");
            }

            function finishTask(taskKey) {
                tasks[taskKey].active = false;
                tasks[taskKey].stopBtn.classList.add('hidden');
                updateTaskStatus(taskKey, "Ho√†n th√†nh!");
            }

            function updateTaskStatus(taskKey, text) {
                const t = tasks[taskKey];
                const p = Math.round((t.currentIndex / Math.max(t.queue.length, 1)) * 100);
                t.progressDiv.querySelector('.task-progress-bar-fill').style.width = `${p}%`;
                t.progressDiv.querySelector('.task-status-text').innerHTML = `<span>${text}</span><span>${p}%</span>`;
            }

            // --- PROCESSORS (UPDATED FOR ENGLISH PHONETICS) ---
            async function processPhoneticsChunk(chunk, container, _, index) {
                const p = getPrompt('pinyin', chunk);
                // Schema uses "phonetic"
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "phonetic": { "type": "STRING" } } } };
                const res = await callAI(p, "application/json", schema);
                // res l√† chu·ªói JSON ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi callAI
                let data = JSON.parse(res);

                data.forEach(item => {
                    const word = (item.word||'').toString();
                    if(item.phonetic) {
                        const r = document.createElement('ruby'); r.className='word-clickable'; r.textContent=word;
                        const rt = document.createElement('rt'); rt.textContent=item.phonetic; r.appendChild(rt);
                        r.onclick = (e) => { e.stopPropagation(); openLookupModal(word, e); };
                        container.appendChild(r);
                    } else {
                        const s = document.createElement('span'); s.innerHTML = word.replace(/ /g, '&nbsp;'); container.appendChild(s);
                    }
                });
            }

            async function processSegmentationChunk(chunk, container, _, index) {
                const p = getPrompt('segment', chunk);
                // Schema uses "phonetic"
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "word": { "type": "STRING" }, "phonetic": { "type": "STRING" } }, required: ["word", "phonetic"] } };
                const res = await callAI(p, "application/json", schema);
                // res l√† chu·ªói JSON ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi callAI
                let data = JSON.parse(res);

                data.forEach(seg => {
                     const word = (seg.word||seg.text||'').toString();
                     if(word==='\n') container.appendChild(document.createElement('br'));
                     else if(word.match(/\b\w+\b/)) { // Check for words/phrases (English)
                        const r = document.createElement('ruby'); r.className='segmented-word';
                        r.textContent=word;
                        if(seg.phonetic) { const rt=document.createElement('rt'); rt.textContent=seg.phonetic; r.appendChild(rt); }
                        r.onclick = (e) => { e.stopPropagation(); openLookupModal(word, e); };
                        container.appendChild(r);
                     } else {
                         const s = document.createElement('span'); s.innerHTML = word.replace(/ /g, '&nbsp;'); container.appendChild(s);
                     }
                });
            }

            async function processExplanationChunk(chunk, container, _, index) {
                const p = getPrompt('explain', chunk);
                const res = await callAI(p, "text/plain");
                container.innerHTML += `<h4 class="font-bold text-indigo-700 mb-2 mt-4">ƒêo·∫°n ${index+1}:</h4>` + res.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') + '<hr class="my-4">';
            }

            async function processTranslationChunk(chunk, container, _, index) {
                const p = getPrompt('translate', chunk);
                const res = await callAI(p, "text/plain");
                container.innerText += res + '\n\n';
            }

            // --- UTILS & API ---
            function getPrompt(type, text) {
                let t = prompts[type].value;
                if(!t.trim()) t = DEFAULT_PROMPTS[type];
                // ƒê·∫£m b·∫£o vƒÉn b·∫£n ƒë∆∞·ª£c l√†m s·∫°ch (trim) tr∆∞·ªõc khi g·ª≠i
                return t.replace('{{TEXT}}', text.trim());
            }

            // H√ÄM CHUNKTEXT M·ªöI: T·ªëi ∆∞u h√≥a vi·ªác g·ªôp ƒëo·∫°n ng·∫Øn (Conditional Merging)
            // function chunkText(text, size) {
            //     const chunks = [];
            //     if (!text) return chunks;
                
            //     // C√†i ƒë·∫∑t k√≠ch th∆∞·ªõc t·ªëi thi·ªÉu cho m·ªôt chunk ƒë·ªÉ tr√°nh l√£ng ph√≠ request
            //     const MIN_CHUNK_SIZE = 50; 
            //     const maxChunkSize = size;
                
            //     // 1. Chia vƒÉn b·∫£n th√†nh c√°c "ph·∫ßn" (g·ªìm ƒëo·∫°n vƒÉn b·∫£n ho·∫∑c d·∫•u ph√¢n c√°ch \n\n)
            //     const parts = text.split(/(\n{2,})/).filter(p => p.length > 0);
                
            //     let currentChunk = '';
                
            //     for(let i = 0; i < parts.length; i++) {
            //         let part = parts[i];
                    
            //         // N·∫øu part l√† d·∫•u ph√¢n c√°ch ƒëo·∫°n c·ª©ng (nh∆∞ \n\n)
            //         if (part.match(/(\n{2,})/)) {
            //             if (currentChunk.trim()) {
            //                 chunks.push(currentChunk.trim());
            //                 currentChunk = '';
            //             }
            //             chunks.push(part); // Th√™m d·∫•u ph√¢n c√°ch ƒëo·∫°n
            //             continue;
            //         }
                    
            //         const trimmedPart = part.trim();
            //         if (!trimmedPart) continue;

            //         let potentialChunk = currentChunk + (currentChunk.length > 0 ? ' ' : '') + trimmedPart;
                    
            //         // Tr∆∞·ªùng h·ª£p 1: Chunk hi·ªán t·∫°i C√ì TH·ªÇ G·ªòP V√ÄO:
            //         if (currentChunk.length > 0 && currentChunk.length < MIN_CHUNK_SIZE) {
            //             // G·ªôp n·∫øu ch∆∞a v∆∞·ª£t qu√° gi·ªõi h·∫°n t·ªëi ƒëa
            //             if (potentialChunk.length <= maxChunkSize) {
            //                 currentChunk = potentialChunk;
            //                 continue;
            //             }
            //             // N·∫øu g·ªôp s·∫Ω v∆∞·ª£t qu√° maxChunkSize, CH·∫§P NH·∫¨N ƒê·∫®Y CHUNK NG·∫ÆN N√ÄY L√äN v√† b·∫Øt ƒë·∫ßu chunk m·ªõi
            //             chunks.push(currentChunk.trim());
            //             currentChunk = trimmedPart;

            //         }
            //         // Tr∆∞·ªùng h·ª£p 2: Chunk hi·ªán t·∫°i l√† chunk ƒë·∫ßu ti√™n ho·∫∑c chunk m·ªõi
            //         else {
            //             if (potentialChunk.length <= maxChunkSize) {
            //                 currentChunk = potentialChunk;
            //             } else {
            //                 // N·∫øu qu√° l·ªõn, ƒë·∫©y chunk hi·ªán t·∫°i (n·∫øu c√≥) v√† b·∫Øt ƒë·∫ßu chunk m·ªõi
            //                 if (currentChunk.trim()) {
            //                     chunks.push(currentChunk.trim());
            //                 }
            //                 currentChunk = trimmedPart;
            //             }
            //         }
                    
            //         // ƒê·∫©y chunk hi·ªán t·∫°i n·∫øu n√≥ ƒë√£ ƒë·∫°t k√≠ch th∆∞·ªõc t·ªëi ƒëa 
            //         if (currentChunk.length >= maxChunkSize || i === parts.length - 1) {
            //              if (currentChunk.trim()) {
            //                  chunks.push(currentChunk.trim());
            //                  currentChunk = '';
            //              }
            //         }
            //     }
                
            //     // ƒê·∫©y ph·∫ßn c√≤n l·∫°i n·∫øu c√≥
            //     if (currentChunk.trim()) {
            //         chunks.push(currentChunk.trim());
            //     }

            //     // L·ªçc cu·ªëi c√πng ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªâ c√≥ c√°c ƒëo·∫°n h·ª£p l·ªá v√† d·∫•u ph√¢n c√°ch (n·∫øu c√≥)
            //     return chunks.filter(c => c.trim().length > 0 || c.match(/(\n{2,})/));
            // }

function chunkText(text, size) {
                const chunks = [];
                if (!text) return chunks;
                
                const maxChunkSize = size;
                
                // 1. Chia to√†n b·ªô vƒÉn b·∫£n th√†nh c√°c c√¢u. C√°c d·∫•u ng·∫Øt ƒëo·∫°n c·ª©ng s·∫Ω ƒë∆∞·ª£c coi l√† c√¢u cu·ªëi c√πng
                const sentences = text.split(/([.?!;\n\r]+)/).filter(Boolean);
                
                let currentChunk = '';
                
                for(let part of sentences) {
                    const trimmedPart = part.trim();
                    if (!trimmedPart) continue; // B·ªè qua c√°c d√≤ng tr·ªëng ho√†n to√†n
                    
                    // N·∫øu ph·∫ßn n√†y l√† m·ªôt k√Ω t·ª± xu·ªëng d√≤ng (kh√¥ng ph·∫£i xu·ªëng d√≤ng k√©p), ch·ªâ th√™m kho·∫£ng tr·∫Øng n·∫øu c·∫ßn
                    if (trimmedPart.match(/^[\n\r]+$/)) {
                        // B·ªè qua, s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω khi hi·ªÉn th·ªã (trong processPhoneticsChunk)
                        continue;
                    }

                    let potentialChunk = currentChunk + (currentChunk.length > 0 ? ' ' : '') + trimmedPart;
                    
                    // N·∫øu g·ªôp c√¢u m·ªõi V∆Ø·ª¢T QU√Å k√≠ch th∆∞·ªõc t·ªëi ƒëa, ƒë·∫©y chunk hi·ªán t·∫°i v√† b·∫Øt ƒë·∫ßu chunk m·ªõi
                    if (potentialChunk.length > maxChunkSize && currentChunk.length > 0) {
                        chunks.push(currentChunk.trim()); 
                        currentChunk = trimmedPart;
                    } else {
                        currentChunk = potentialChunk;
                    }
                }
                
                // ƒê·∫©y ph·∫ßn c√≤n l·∫°i (n·∫øu c√≥)
                if (currentChunk.trim()) {
                    chunks.push(currentChunk.trim());
                }

                // K·∫øt qu·∫£ l√† m·∫£ng c√°c kh·ªëi l·ªõn, kh√¥ng bao g·ªìm c√°c d√≤ng tr·ªëng.
                return chunks;
            }

            function parseAiJson(str) {
                try {
                    // B∆∞·ªõc 0: L√†m s·∫°ch tri·ªát ƒë·ªÉ chu·ªói ƒë·∫ßu v√†o
                    // Lo·∫°i b·ªè c√°c k√Ω t·ª± ƒëi·ªÅu khi·ªÉn Unicode kh√¥ng in ƒë∆∞·ª£c (bao g·ªìm BOM)
                    let cleanStr = String(str)
                        .replace(/[\u0000-\u001F\u007F-\u009F]/g, '')
                        .trim(); 

                    // B∆∞·ªõc 1: T√¨m v·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa kh·ªëi JSON ƒë·∫ßu ti√™n
                    const jsonStart = cleanStr.indexOf('[');
                    const objStart = cleanStr.indexOf('{');
                    
                    let start = -1;
                    if (jsonStart !== -1 && objStart !== -1) {
                         start = Math.min(jsonStart, objStart);
                    } else if (jsonStart !== -1) {
                         start = jsonStart;
                    } else if (objStart !== -1) {
                         start = objStart;
                    }
                    
                    if (start === -1) {
                        // In chu·ªói ƒë√£ ƒë∆∞·ª£c l√†m s·∫°ch nh∆∞ng v·∫´n b·ªã l·ªói
                        console.error("Input string after deep clean:", cleanStr); 
                        throw new Error("Kh√¥ng t√¨m th·∫•y kh·ªëi JSON m·ªü ƒë·∫ßu.");
                    }
                    
                    let jsonStr = cleanStr.substring(start);
                    let openBracketCount = 0;
                    let openBraceCount = 0;
                    let jsonEnd = -1;

                    // B∆∞·ªõc 2: T√¨m v·ªã tr√≠ k·∫øt th√∫c h·ª£p l·ªá c·ªßa kh·ªëi JSON ƒê·∫¶U TI√äN
                    for (let i = 0; i < jsonStr.length; i++) {
                        const char = jsonStr[i];
                        
                        if (char === '{') {
                            openBraceCount++;
                        } else if (char === '}') {
                            openBraceCount--;
                        } else if (char === '[') {
                            openBracketCount++;
                        } else if (char === ']') {
                            openBracketCount--;
                        }
                        
                        // Kh·ªëi JSON k·∫øt th√∫c khi s·ªë l∆∞·ª£ng ngo·∫∑c m·ªü v√† ƒë√≥ng c√¢n b·∫±ng v√† ƒë·∫°t ƒë·∫øn 0
                        if ((openBraceCount === 0 && openBracketCount === 0) && (char === '}' || char === ']')) {
                            jsonEnd = i;
                            break;
                        }
                    }

                    if (jsonEnd === -1) {
                        throw new Error("Kh√¥ng t√¨m th·∫•y kh·ªëi JSON ƒë√≥ng c√¢n b·∫±ng.");
                    }

                    // C·∫Øt chu·ªói JSON h·ª£p l·ªá
                    jsonStr = jsonStr.substring(0, jsonEnd + 1).trim();

                    // B∆∞·ªõc 3: X·ª≠ l√Ω tr∆∞·ªùng h·ª£p AI t·ª± ƒë·ªông th√™m d·∫•u nh√°y k√©p bao quanh JSON
                    if (jsonStr.startsWith('"') && jsonStr.endsWith('"')) {
                        jsonStr = jsonStr.substring(1, jsonStr.length - 1).replace(/\\"/g, '"');
                    }
                    
                    // Th·ª±c hi·ªán parse
                    const json = JSON.parse(jsonStr);
                    
                    // Tr·∫£ v·ªÅ d·ªØ li·ªáu
                    if(Array.isArray(json)) return json;
                    for(let k in json) if(Array.isArray(json[k])) return json[k];
                    
                    if (typeof json === 'object' && json !== null) return json;

                    return [json];
                } catch(e) { 
                    console.error("L·ªói ph√¢n t√≠ch JSON chi ti·∫øt:", e);
                    throw new Error("L·ªói ph√¢n t√≠ch JSON"); 
                }
            }
            async function callAI(prompt, mimeType, schema) {
                const key = apiKeyInput.value.trim();
                const provider = aiProviderSelect.value;
                if(!key) throw new Error("Thi·∫øu API Key");

                let url, body;
                if(provider === 'gemini') {
                    url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${key}`;
                    body = { 
                        contents: [{ role: "user", parts: [{ text: prompt }] }], 
                        generationConfig: { 
                            responseMimeType: mimeType 
                        } 
                    };
                    if(schema) body.generationConfig.responseSchema = schema;
                } else {
                    url = 'https://api.deepseek.com/chat/completions';
                    const isJson = mimeType === 'application/json';
                    body = {
                        model: "deepseek-chat",
                        messages: [{ role: "system", content: isJson ? "JSON format." : "" }, { role: "user", content: prompt }],
                        stream: false
                    };
                    if(isJson) body.response_format = { type: "json_object" };
                }

                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', ...(provider==='deepseek' && {'Authorization': `Bearer ${key}`}) }, body: JSON.stringify(body) });
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                
                let txt = provider === 'gemini' ? json.candidates?.[0]?.content?.parts?.[0]?.text : json.choices?.[0]?.message?.content;
                if(!txt) throw new Error("No response");
                
                // IN K·∫æT QU·∫¢ TH√î C·ª¶A AI RA CONSOLE
                console.log("AI Raw Text:", txt);
                
                if(mimeType === 'application/json') {
                    // Tr√≠ch xu·∫•t JSON v√† tr·∫£ v·ªÅ chu·ªói JSON ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω (ƒë·ªÉ tr√°nh parse 2 l·∫ßn)
                    const parsedData = parseAiJson(txt);
                    return JSON.stringify(parsedData);
                }
                
                console.log("AI:", txt);
                return txt;
            }

            // async function callAI(prompt, mimeType, schema) {
            //     const key = apiKeyInput.value.trim();
            //     const provider = aiProviderSelect.value;
            //     if(!key) throw new Error("Thi·∫øu API Key");

            //     let url, body;
            //     if(provider === 'gemini') {
            //         url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${key}`;
            //         body = { 
            //             contents: [{ role: "user", parts: [{ text: prompt }] }], 
            //             generationConfig: { 
            //                 responseMimeType: mimeType 
            //             } 
            //         };
            //         if(schema) body.generationConfig.responseSchema = schema;
            //     } else {
            //         url = 'https://api.deepseek.com/chat/completions';
            //         const isJson = mimeType === 'application/json';
            //         body = {
            //             model: "deepseek-chat",
            //             messages: [{ role: "system", content: isJson ? "JSON format." : "" }, { role: "user", content: prompt }],
            //             stream: false
            //         };
            //         if(isJson) body.response_format = { type: "json_object" };
            //     }

            //     const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', ...(provider==='deepseek' && {'Authorization': `Bearer ${key}`}) }, body: JSON.stringify(body) });
            //     if(!res.ok) throw new Error(`HTTP ${res.status}`);
            //     const json = await res.json();
                
            //     let txt = provider === 'gemini' ? json.candidates?.[0]?.content?.[0]?.text : json.choices?.[0]?.message?.content;
            //     if(!txt) throw new Error("No response");
                
            //     // IN K·∫æT QU·∫¢ TH√î C·ª¶A AI RA CONSOLE
            //     console.log("AI Raw Text:", txt);
                
            //     if(mimeType === 'application/json') {
            //         // Tr√≠ch xu·∫•t JSON v√† tr·∫£ v·ªÅ chu·ªói JSON ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω (ƒë·ªÉ tr√°nh parse 2 l·∫ßn)
            //         const parsedData = parseAiJson(txt);
            //         return JSON.stringify(parsedData);
            //     }
                
            //     console.log("AI:", txt);
            //     return txt;
            // }

            // --- EVENT LISTENERS ---
            // Task Buttons
            document.getElementById('pinyin-button').addEventListener('click', () => startTask('pinyin'));
            document.getElementById('segment-text-button').addEventListener('click', () => startTask('segment'));
            document.getElementById('explain-text-button').addEventListener('click', () => startTask('explain'));
            document.getElementById('translate-full-text-button').addEventListener('click', () => startTask('translate'));
            // Stop Buttons
            document.getElementById('stop-pinyin').addEventListener('click', () => stopTask('pinyin'));
            document.getElementById('stop-segment').addEventListener('click', () => stopTask('segment'));
            document.getElementById('stop-explain').addEventListener('click', () => stopTask('explain'));
            document.getElementById('stop-translate').addEventListener('click', () => stopTask('translate'));
            // Toggle Buttons
            document.querySelectorAll('.toggle-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    let content;
                    if(targetId) content = document.getElementById(targetId);
                    else content = btn.closest('.section-header').nextElementSibling;
                    
                    if(content) {
                        content.classList.toggle('hidden');
                        btn.textContent = content.classList.contains('hidden') ? 'Hi·ªÉn th·ªã' : 'Thu g·ªçn';
                    }
                });
            });
            // Copy Buttons
            document.querySelectorAll('.copy-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.getAttribute('data-target');
                    if(targetId) {
                        const contentDiv = document.getElementById(targetId);
                         copyHtmlToClipboard(contentDiv);
                    } else {
                        const content = btn.closest('.section-header').nextElementSibling;
                        copyHtmlToClipboard(content);
                    }
                });
            });
            // Settings Buttons
            Object.values(prompts).forEach((el, i) => {
                const keys = ['promptPinyin', 'promptSegment', 'promptExplain', 'promptTranslate'];
                el.addEventListener('change', () => localStorage.setItem(keys[i], el.value));
            });
            resetPromptsBtn.addEventListener('click', () => {
                if(confirm("Kh√¥i ph·ª•c prompt g·ªëc?")) {
                    localStorage.removeItem('promptPinyin'); localStorage.removeItem('promptSegment');
                    localStorage.removeItem('promptExplain'); localStorage.removeItem('promptTranslate');
                    loadPrompts();
                }
            });
            function updateApiKeyGuide() { 
                apiKeyGuide.innerHTML = aiProviderSelect.value === 'gemini' ? 'L·∫•y API Key t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a>.'
                : 'L·∫•y API Key t·∫°i <a href="https://platform.deepseek.com/api_keys" target="_blank" class="text-blue-600 hover:underline">DeepSeek Platform</a>.';
            }
            aiProviderSelect.addEventListener('change', () => { localStorage.setItem('dichiAiProvider', aiProviderSelect.value); updateApiKeyGuide(); });
            saveApiKeyButton.addEventListener('click', () => { localStorage.setItem('dichiApiKey', apiKeyInput.value); apiKeyStatus.textContent = "ƒê√£ l∆∞u!"; setTimeout(() => apiKeyStatus.textContent = "", 2000); });
            chunkSizeInput.addEventListener('change', () => localStorage.setItem('dichiChunkSize', chunkSizeInput.value));

            // File Upload
            fileUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                e.target.value = ''; fileNameSpan.textContent = file.name;
                if(file.name.toLowerCase().endsWith('.docx')) {
                    if(window.mammoth) window.mammoth.convertToHtml({arrayBuffer: file}).then(r => processNewContent(r.value, true)).catch(err => alert(err));
                    else { const reader = new FileReader(); reader.onload = ev => window.mammoth.convertToHtml({arrayBuffer: ev.target.result}).then(r => processNewContent(r.value, true)); reader.readAsArrayBuffer(file); }
                } else {
                    const reader = new FileReader(); reader.onload = ev => processNewContent(ev.target.result); reader.readAsText(file);
                }
            });
            processTextButton.addEventListener('click', () => { if(textInputArea.value) processNewContent(textInputArea.value); });
            
            fetchUrlButton.addEventListener('click', async () => {
                if(!urlInput.value) return;
                fetchUrlButton.disabled = true; textDisplay.textContent = "ƒêang t·∫£i...";
                try {
                    const res = await fetch(`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(urlInput.value)}`);
                    const html = await res.text();
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const content = (doc.querySelector('article') || doc.querySelector('main') || doc.body).innerText;
                    processNewContent(content);
                } catch(e) { textDisplay.textContent = "L·ªói t·∫£i URL"; }
                fetchUrlButton.disabled = false;
            });

            function processNewContent(content, isHtml=false) {
                speechSynthesis.cancel();
                Object.keys(tasks).forEach(k => { tasks[k].queue=[]; tasks[k].active=false; tasks[k].section.classList.add('hidden'); tasks[k].container.innerHTML=''; });
                requestQueue.length = 0;
                
                if(isHtml) { textDisplay.innerHTML = content; currentRawText = textDisplay.innerText.trim(); } // Trim raw text
                else { textDisplay.textContent = content; currentRawText = content.trim(); } // Trim raw text
                
                addClickableSpansTo(textDisplay, currentRawText);
                document.getElementById('text-stats-section').classList.remove('hidden');
                document.getElementById('char-count').textContent = currentRawText.length;
                // Correctly count English words
                document.getElementById('word-count').textContent = currentRawText.split(/\s+/).filter(w => w.length > 0).length;
            }

            function addClickableSpansTo(el, text) {
                el.innerHTML = '';
                // Split by English words (\b\w+\b) and non-word characters/spaces
                text.split(/(\b\w+\b|\n)/).forEach(part => {
                    if(part.match(/\b\w+\b/)) {
                        // Treat the word itself as the clickable unit
                        const s = document.createElement('span'); s.textContent = part; s.className = 'word-clickable';
                        s.onclick = (e) => { e.stopPropagation(); openLookupModal(part, e); };
                        el.appendChild(s);
                    } else if(part === '\n') {
                         el.appendChild(document.createElement('br'));
                    }
                    else el.appendChild(document.createTextNode(part));
                });
            }

            // AI Tools
            const aiSpinner = document.getElementById('loading-spinner');
            document.getElementById('ai-generate-sentence-button').addEventListener('click', async () => {
                const w = document.getElementById('ai-custom-input').value; if(!w) return;
                aiSpinner.style.display = 'block'; document.getElementById('ai-sentence-results-section').classList.remove('hidden');
                try {
        const prompt = `T·∫°o 5 c√¢u v√≠ d·ª• ti·∫øng Anh cho t·ª´ "${w}". \nQuan tr·ªçng: Meaning (Nghƒ©a) ph·∫£i l√† TI·∫æNG VI·ªÜT. \nJSON: {"items": [{"sentence": "...", "phonetic": "...", "meaning": "..."}]}`;
        const resStr = await callAI(prompt, "application/json");
        // --- ƒêI·ªÄU CH·ªàNH L·ªñI PH√ÇN T√çCH ---
        const jsonResponse = JSON.parse(resStr);
        // ƒê·∫£m b·∫£o data l√† m·∫£ng, l·∫•y t·ª´ kh√≥a 'items'
        const data = Array.isArray(jsonResponse) ? jsonResponse : jsonResponse.items || [];
        // ---------------------------------
        document.getElementById('ai-sentence-content').innerHTML = data.map(i => `<div class="mb-2"><b>${i.sentence}</b><br><span class="text-gray-500 text-sm">${i.phonetic}</span><br><span class="text-blue-600 text-sm">${i.meaning}</span></div>`).join('');
               
                } catch(e) { alert(e.message); }
                finally { aiSpinner.style.display = 'none'; }
            });
            document.getElementById('ai-generate-related-words-button').addEventListener('click', async () => {
                 const w = document.getElementById('ai-custom-input').value; if(!w) return;
                aiSpinner.style.display = 'block'; document.getElementById('ai-related-words-results-section').classList.remove('hidden');
                try {
        const prompt = `T√¨m 10 t·ª´ li√™n quan ƒë·∫øn "${w}" trong ti·∫øng Anh. \nQuan tr·ªçng: Meaning (Nghƒ©a) ph·∫£i l√† TI·∫æNG VI·ªÜT. \nJSON: {"items": [{"word": "...", "phonetic": "...", "meaning": "..."}]}`;
        const resStr = await callAI(prompt, "application/json");
        
        // --- ƒêI·ªÄU CH·ªàNH L·ªñI PH√ÇN T√çCH ---
        const jsonResponse = JSON.parse(resStr);
        // ƒê·∫£m b·∫£o data l√† m·∫£ng, l·∫•y t·ª´ kh√≥a 'items'
        const data = Array.isArray(jsonResponse) ? jsonResponse : jsonResponse.items || [];
        // ---------------------------------
        document.getElementById('ai-related-words-content').innerHTML 
        = `<div class="grid grid-cols-2 gap-2">` + data.map(i => `<div class="p-2 border rounded cursor-pointer hover:bg-blue-50" onclick="document.getElementById('ai-custom-input').value='${i.word}'"><b>${i.word}</b><br><span class="text-xs">${i.phonetic}</span><br><span class="text-xs text-gray-600">${i.meaning}</span></div>`).join('') + `</div>`;
                } catch(e) { alert(e.message); }
                finally { aiSpinner.style.display = 'none'; }
            });

async function openLookupModal(word, e) {
    selectedWordModalSpan.textContent = word;
    googleTranslateResultDiv.innerHTML = ''; lookupModalOverlay.style.display = 'block';
    
    const enc = encodeURIComponent(word);
    // Updated links for English dictionaries
    document.getElementById('cambridge-link-modal').href = `https://dictionary.cambridge.org/dictionary/english/${enc}`;
    document.getElementById('youglish-link-modal').href = `https://youglish.com/pronounce/${enc}/english`;
    document.getElementById('vtudien-link-modal').href = `https://vtudien.com/anh-viet/dictionary/nghia-cua-tu-${enc}`;
    
    const modalWidth = modalContentInner.offsetWidth;
    const modalHeight = modalContentInner.offsetHeight;
    let left = e.clientX; let top = e.clientY;
    if (left + modalWidth > window.innerWidth) left = window.innerWidth - modalWidth - 20;
    if (top + modalHeight > window.innerHeight) top = window.innerHeight - modalHeight - 20;
    
    modalContentInner.style.top = `${top}px`; modalContentInner.style.left = `${left}px`;
    
    // ƒê·∫£m b·∫£o g√°n h√†m speakWord v·ªõi t·ª´ c·∫ßn tra
    pronounceWordButton.onclick = () => speakWord(word); 
    copyWordButton.onclick = () => copyToClipboard(word);
    
    if(aiCustomInput) aiCustomInput.value = word;
    if(autoPlayToggle && autoPlayToggle.checked) speakWord(word);

    try {
        const resStr = await getTranslation(word);
        const res = JSON.parse(resStr);
        // phonetic replaces pinyin
        googleTranslateResultDiv.innerHTML = `<b>${res.phonetic}</b><br>${res.meaning}`;
    } catch(e) { 
        console.error("L·ªói khi d·ªãch t·ª´ modal:", e);
        googleTranslateResultDiv.innerHTML = 'L·ªói d·ªãch'; 
    }
}
            async function getTranslation(word) {

            const prompt = `D·ªãch t·ª´/c·ª•m t·ª´ ti·∫øng Anh "${word}" sang ti·∫øng Vi·ªát. 
B·∫ÆT BU·ªòC KH√îNG TH√äM B·∫§T K·ª≤ VƒÇN B·∫¢N HAY L·ªúI GI·ªöI THI·ªÜU N√ÄO.
B·∫ÆT BU·ªòC ch·ªâ tr·∫£ v·ªÅ JSON v·ªõi hai tr∆∞·ªùng: "phonetic" (IPA chu·∫©n) v√† "meaning" (Nghƒ©a Vi·ªát).
V√≠ d·ª•: {"phonetic": "...", "meaning": "..."}`;
                 const res = await callAI(prompt, "application/json");
                 return res;
            }
            
            closeLookupModalBtn.addEventListener('click', () => lookupModalOverlay.style.display = 'none');
            closeSelectionPopupBtn.addEventListener('click', () => selectionPopup.classList.add('hidden'));

            // Selection Popup
            document.addEventListener('mouseup', (e) => {
                setTimeout(() => {
                    const s = window.getSelection(); if (!s || s.isCollapsed) return;
                    const t = s.toString().trim(); 
                    if (!t || t.length < 2 || selectionPopup.contains(e.target) || modalContentInner.contains(e.target) || e.target.closest('.word-clickable')) return;
 
                    lookupModalOverlay.style.display = 'none'; selectionPopup.classList.remove('hidden');
                    
                    const r = s.getRangeAt(0).getBoundingClientRect();
                    let top = r.bottom + window.scrollY + 5; let left = r.left + window.scrollX;
  
                    selectionPopup.style.top = `${top}px`; selectionPopup.style.left = `${left}px`;
                    
                    if(aiCustomInput) aiCustomInput.value = t;
                    if(autoPlayToggle && autoPlayToggle.checked) speakWord(t);
                    
                    copySelectionButton.onclick = () => { copyToClipboard(t); selectionPopup.classList.add('hidden'); };
                    translateSelectionButton.onclick = async () => { 
                        selectionTranslateResultDiv.classList.add('hidden');
                        selectionTranslateSpinner.style.display = 'block';
                        try {
                             const resStr = await getTranslation(t); 
                             const r = JSON.parse(resStr);
                             if(r.meaning) { selectionTranslateResultDiv.innerHTML = `<strong>D·ªãch:</strong> ${r.phonetic} - ${r.meaning}`; selectionTranslateResultDiv.classList.remove('hidden'); }
                        } catch (error) {
                             selectionTranslateResultDiv.innerHTML = `<strong>D·ªãch:</strong> L·ªói: ${error.message}`; selectionTranslateResultDiv.classList.remove('hidden'); 
                        }
                        selectionTranslateSpinner.style.display = 'none';
                    };
                    pronounceSelectionButton.onclick = () => speakWord(t);
                    cambridgeSelectionLink.href = `https://dictionary.cambridge.org/dictionary/english/${encodeURIComponent(t)}`;
                }, 0);
            });

            mediaUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0]; if(!file) return;
                const url = URL.createObjectURL(file);
                if(activeMediaPlayer) { activeMediaPlayer.pause(); activeMediaPlayer.src = ""; }
                
                document.getElementById('media-container').classList.remove('hidden');
                document.getElementById('media-filename').textContent = file.name;
                const v = document.getElementById('main-media-player');
                const a = document.getElementById('main-audio-player');
                
                if(file.type.startsWith('video')) { 
                    v.src = url; v.style.display = 'block'; a.style.display = 'none'; activeMediaPlayer = v;
                } else { 
                    a.src = url; a.style.display = 'block'; v.style.display = 'none'; activeMediaPlayer = a;
                }
                
                document.getElementById('media-controls').classList.remove('opacity-50', 'pointer-events-none');
                activeMediaPlayer.onplay = () => { speechSynthesis.cancel(); };
            });
            mediaRewindBtn.addEventListener('click', () => { if(activeMediaPlayer) activeMediaPlayer.currentTime -= 10; });
            mediaForwardBtn.addEventListener('click', () => { if(activeMediaPlayer) activeMediaPlayer.currentTime += 10; });
            mediaRateSelect.addEventListener('change', (e) => { if(activeMediaPlayer) activeMediaPlayer.playbackRate = parseFloat(e.target.value); });

            // Load Config
            if(localStorage.getItem('dichiApiKey')) apiKeyInput.value = localStorage.getItem('dichiApiKey');
            if(localStorage.getItem('dichiAiProvider')) aiProviderSelect.value = localStorage.getItem('dichiAiProvider');
            if(localStorage.getItem('dichiChunkSize')) chunkSizeInput.value = localStorage.getItem('dichiChunkSize');
            updateApiKeyGuide();
        }
        window.addEventListener('load', mainApp);
    </script>
</body>
</html>
