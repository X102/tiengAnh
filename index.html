<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đọc tiếng Anh</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mammoth.js for reading .docx files -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
        }
        textarea {
            resize: vertical;
            min-height: 150px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .custom-file-upload {
            border: 2px solid #4f46e5;
            display: inline-block;
            padding: 8px 16px;
            cursor: pointer;
            background-color: #f0f2f5;
            color: #4f46e5;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .custom-file-upload:hover {
            background-color: #e0e7ff;
        }
        input[type="file"] {
            display: none;
        }
        .prose {
            max-width: none;
        }
        .section-content {
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            overflow: hidden;
        }
        /* Styles for IPA on top of words */
        .word-with-ipa {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 1px 12px;
            vertical-align: bottom;
            text-align: center;
        }
        .ipa-text-above {
            font-size: 0.75rem; /* 12px */
            color: #ef4444; /* red-500 */
            line-height: 1;
            display: block;
            min-height: 1em; /* Prevent layout shift */
        }
        .original-word-below {
            font-size: 1.125rem; /* 18px */
            line-height: 1.25;
            cursor: pointer;
        }
        .original-word-below:hover {
            background-color: #e0e7ff; /* indigo-100 */
            border-radius: 3px;
        }
        /* Style for offline lookup */
         .clickable-word-offline {
             cursor: pointer;
        }
        .clickable-word-offline:hover {
            background-color: #e0e7ff; /* indigo-100 */
            border-radius: 3px;
        }
        #selectionPopup {
            position: absolute;
            z-index: 1000;
            background-color: #1f2937; /* gray-800 */
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: opacity 0.1s ease-in-out;
        }
        #selectionPopup button, #selectionPopup a {
            background: none;
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        #selectionPopup button:hover, #selectionPopup a:hover {
            background-color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">
    <div class="container bg-white p-4 sm:p-6 rounded-lg shadow-xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Học tiếng Anh cùng AI</h1>

        <!-- Input Section -->
        <div class="mb-4">
            <label for="englishInput" class="block text-gray-700 text-sm font-medium mb-2">Nhập văn bản tiếng Anh hoặc tải file .docx:</label>
            <textarea id="englishInput"
                      class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200"
                      placeholder="Nhập văn bản vào đây..."
                      rows="6"></textarea>
            <div class="flex justify-between items-center mt-2 text-sm text-gray-500">
                <span id="textCounter">0 từ / 0 ký tự</span>
                <div>
                    <label for="file-upload" class="custom-file-upload text-xs">
                        Tải lên .docx
                    </label>
                    <input id="file-upload" type="file" accept=".docx"/>
                    <span id="fileName" class="ml-2"></span>
                </div>
            </div>
        </div>

        <!-- Collapsible API Key Input -->
        <div class="mb-6 border border-gray-200 rounded-md">
            <button id="toggleApiSection" class="w-full flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100">
                <span class="font-medium text-gray-700">Cấu hình Khóa API Gemini</span>
                <svg id="apiChevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform transform" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="apiSectionContent" class="p-4 hidden">
                <div class="relative">
                    <input type="password" id="apiKeyInput"
                           class="w-full p-3 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                           placeholder="Nhập khóa API của bạn vào đây...">
                    <button id="toggleApiKeyVisibility" type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        <svg id="eyeOffIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A10.059 10.059 0 01.458 10c1.274 4.057 5.022 7 9.542 7 1.126 0 2.207-.245 3.232-.697z" /></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Feature Buttons -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
            <button data-feature="offline-lookup" class="feature-button bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Tra từ (Offline)</button>
            <button data-feature="ipa" class="feature-button bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Phiên âm (AI)</button>
            <button data-feature="translate" class="feature-button bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Dịch (AI)</button>
            <button data-feature="grammar" class="feature-button bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Ngữ pháp (AI)</button>
        </div>
        
        <div id="globalErrorMessage" class="text-red-600 mb-4 hidden text-center"></div>

        <!-- Output Sections -->
        <div id="output-sections" class="space-y-4">
            <!-- Read Aloud Section -->
            <div class="border border-gray-200 rounded-md">
                <div class="w-full flex justify-between items-center p-3 bg-gray-50">
                    <h2 class="text-lg font-semibold text-gray-800">Đọc toàn bộ văn bản</h2>
                </div>
                <div class="p-4 space-y-4">
                     <div class="flex flex-col sm:flex-row flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-2">
                             <button id="mainPlayPauseButton" class="bg-green-600 text-white p-2 rounded-md hover:bg-green-700 flex items-center justify-center" title="Phát/Tạm dừng">
                                <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                                <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                             <button id="mainStopButton" class="bg-red-600 text-white p-2 rounded-md hover:bg-red-700 flex items-center justify-center" title="Dừng hẳn">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label for="mainVoiceSelect" class="text-sm font-medium">Giọng đọc:</label>
                            <select id="mainVoiceSelect" class="p-2 border border-gray-300 rounded-md w-full flex-1"></select>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <label for="mainRateSlider" class="text-sm font-medium">Tốc độ:</label>
                            <input type="range" id="mainRateSlider" min="0.5" max="2" value="1" step="0.1" class="w-full flex-1">
                            <span id="mainRateValue" class="text-sm font-medium">1.0x</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Dynamic Output Sections will be inserted here -->
        </div>
        
        <!-- Ask AI Section -->
        <div class="mt-8 border border-gray-200 rounded-md">
            <div class="w-full flex justify-between items-center p-3 bg-gray-50">
                <h2 class="text-lg font-semibold text-gray-800">Hỏi AI về văn bản</h2>
            </div>
            <div class="p-4 space-y-4">
                <textarea id="aiQuestionInput" class="w-full p-3 border border-gray-300 rounded-md" placeholder="Đặt câu hỏi về nội dung văn bản ở trên..." rows="2"></textarea>
                <button id="askAIButton" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Gửi câu hỏi</button>
                <div id="aiAnswerContainer">
                    <!-- AI Answer will be rendered here, inside a dynamic section -->
                </div>
            </div>
        </div>
        
        <!-- Reference Links Section -->
        <div class="mt-8 border border-gray-200 rounded-md">
            <div class="w-full p-3 bg-gray-50">
                <h2 class="text-lg font-semibold text-gray-800">Tài liệu học tiếng Anh tham khảo</h2>
            </div>
            <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-blue-600">
                <a href="https://tophonetics.com/" target="_blank" class="hover:underline">toPhonetics</a>
                <a href="https://www.bbc.co.uk/learningenglish" target="_blank" class="hover:underline">BBC Learning English - Tin tức & bài học</a>
                <a href="https://dictionary.cambridge.org/" target="_blank" class="hover:underline">Cambridge Dictionary - Từ điển Anh-Anh, Anh-Việt</a>
                <a href="https://www.ted.com/" target="_blank" class="hover:underline">TED Talks - Luyện nghe qua các bài diễn thuyết</a>
                <a href="https://www.grammarly.com/blog/" target="_blank" class="hover:underline">Grammarly Blog - Mẹo ngữ pháp</a>
                <a href="https://youglish.com/" target="_blank" class="hover:underline">YouGlish - Luyện phát âm qua video Youtube</a>
                <a href="https://vtudien.com/" target="_blank" class="hover:underline">Việt Từ Điển - Đa ngôn ngữ</a>
            </div>
        </div>
    </div>

    <!-- Selection Popup -->
    <div id="selectionPopup" class="flex flex-wrap items-center gap-2">
        <button id="popupPronounce" title="Phát âm"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217z" clip-rule="evenodd" /></svg></button>
        <button id="popupCopy" title="Sao chép"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button>
        <button id="popupTranslateAI" title="Dịch bằng AI">AI</button>
        <button id="popupIPA" title="Phiên âm">IPA</button>
        <a id="popupVtudien" href="#" target="_blank" title="Tra trên Vtudien">V</a>
        <a id="popupCambridge" href="#" target="_blank" title="Tra trên Cambridge">C</a>
        <a id="popupYouglish" href="#" target="_blank" title="Tra trên Youglish">Y</a>
        <a id="popupGoogle" href="#" target="_blank" title="Dịch với Google">G</a>
    </div>

    <!-- Dictionary Popup Modal -->
    <div id="dictionaryModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-3 mb-4 flex-shrink-0">
                <h3 class="text-2xl font-bold text-gray-800" id="modalWord"></h3>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="overflow-y-auto pr-2 space-y-4">
                <div class="space-y-3">
                    <div class="flex flex-wrap items-center gap-4">
                        <button id="modalSpeakButton" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center transition">
                            <span id="modalSpeakButtonText">Phát âm</span>
                        </button>
                        <div class="flex items-center gap-2">
                            <input type="range" id="modalRateSlider" min="0.5" max="2" value="1" step="0.1" class="w-24">
                            <span id="modalRateValue" class="text-sm font-medium">1.0x</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="autoPronounceCheckbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="autoPronounceCheckbox" class="ml-2 block text-sm text-gray-900">Tự động phát âm khi chọn từ</label>
                    </div>
                </div>
                <div id="modalDefinitionContainer" class="p-3 bg-gray-100 rounded-md">
                     <div id="modalDefinitionLoading" class="loading-spinner mx-auto"></div>
                     <p class="font-semibold text-gray-700">IPA: <span id="modalIpa" class="font-normal"></span></p>
                     <p class="font-semibold text-gray-700">Nghĩa: <span id="modalMeaning" class="font-normal"></span></p>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-center">
                    <button id="modalCopyButton" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md transition">Sao chép</button>
                    <a id="vtudienLink" href="#" target="_blank" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md transition">Tra Vtudien</a>
                    <a id="youglishLink" href="#" target="_blank" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md transition">Tra Youglish</a>
                    <a id="cambridgeLink" href="#" target="_blank" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md transition">Tra Cambridge</a>
                    <button id="generateSentenceButton" class="p-2 bg-blue-200 hover:bg-blue-300 rounded-md transition">Tạo câu</button>
                    <button id="generateWordsButton" class="p-2 bg-blue-200 hover:bg-blue-300 rounded-md transition">Từ liên quan</button>
                </div>
                <div id="modalDynamicContent" class="mt-4 space-y-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM ELEMENT MAPPING ---
        const DOMElements = {
            englishInput: document.getElementById('englishInput'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            globalErrorMessage: document.getElementById('globalErrorMessage'),
            outputSections: document.getElementById('output-sections'),
            featureButtons: document.querySelectorAll('.feature-button'),
            selectionPopup: document.getElementById('selectionPopup'),
            popupPronounce: document.getElementById('popupPronounce'),
            popupCopy: document.getElementById('popupCopy'),
            popupTranslateAI: document.getElementById('popupTranslateAI'),
            popupIPA: document.getElementById('popupIPA'),
            popupVtudien: document.getElementById('popupVtudien'),
            popupCambridge: document.getElementById('popupCambridge'),
            popupYouglish: document.getElementById('popupYouglish'),
            popupGoogle: document.getElementById('popupGoogle'),
            fileUpload: document.getElementById('file-upload'),
            fileNameSpan: document.getElementById('fileName'),
            toggleApiKeyVisibility: document.getElementById('toggleApiKeyVisibility'),
            eyeIcon: document.getElementById('eyeIcon'),
            eyeOffIcon: document.getElementById('eyeOffIcon'),
            toggleApiSection: document.getElementById('toggleApiSection'),
            apiSectionContent: document.getElementById('apiSectionContent'),
            apiChevron: document.getElementById('apiChevron'),
            textCounter: document.getElementById('textCounter'),
            mainPlayPauseButton: document.getElementById('mainPlayPauseButton'),
            playIcon: document.getElementById('playIcon'),
            pauseIcon: document.getElementById('pauseIcon'),
            mainStopButton: document.getElementById('mainStopButton'),
            mainVoiceSelect: document.getElementById('mainVoiceSelect'),
            mainRateSlider: document.getElementById('mainRateSlider'),
            mainRateValue: document.getElementById('mainRateValue'),
            askAIButton: document.getElementById('askAIButton'),
            aiQuestionInput: document.getElementById('aiQuestionInput'),
            aiAnswerContainer: document.getElementById('aiAnswerContainer'),
            dictionaryModal: document.getElementById('dictionaryModal'),
            closeModalButton: document.getElementById('closeModalButton'),
            modalWord: document.getElementById('modalWord'),
            modalSpeakButton: document.getElementById('modalSpeakButton'),
            modalRateSlider: document.getElementById('modalRateSlider'),
            modalRateValue: document.getElementById('modalRateValue'),
            autoPronounceCheckbox: document.getElementById('autoPronounceCheckbox'),
            modalDefinitionContainer: document.getElementById('modalDefinitionContainer'),
            modalDefinitionLoading: document.getElementById('modalDefinitionLoading'),
            modalIpa: document.getElementById('modalIpa'),
            modalMeaning: document.getElementById('modalMeaning'),
            modalCopyButton: document.getElementById('modalCopyButton'),
            vtudienLink: document.getElementById('vtudienLink'),
            youglishLink: document.getElementById('youglishLink'),
            cambridgeLink: document.getElementById('cambridgeLink'),
            generateSentenceButton: document.getElementById('generateSentenceButton'),
            generateWordsButton: document.getElementById('generateWordsButton'),
            modalDynamicContent: document.getElementById('modalDynamicContent'),
        };

        let voices = [];
        let currentSelectedText = '';
        let mainUtterance = null;
        let ttsState = 'idle'; // 'idle', 'playing', 'paused'
        let aiProcessState = { isRunning: false, isPaused: false, shouldStop: false };

        // --- CORE & UTILITY FUNCTIONS ---
        function showGlobalError(message) {
            DOMElements.globalErrorMessage.textContent = message;
            DOMElements.globalErrorMessage.classList.toggle('hidden', !message);
        }

        function copyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Đã sao chép!');
            } catch (err) {
                alert('Không thể sao chép văn bản.');
            }
            document.body.removeChild(textArea);
        }
        
        function chunkText(text, maxWords = 150) {
            const sentences = text.match(/[^.!?]+[.!?]+|\S+/g) || [];
            const chunks = [];
            let currentChunk = [];
            let currentWordCount = 0;

            for (const sentence of sentences) {
                const wordCount = (sentence.match(/\s+/g) || []).length + 1;
                if (currentWordCount + wordCount > maxWords && currentChunk.length > 0) {
                    chunks.push(currentChunk.join(' '));
                    currentChunk = [];
                    currentWordCount = 0;
                }
                currentChunk.push(sentence);
                currentWordCount += wordCount;
            }

            if (currentChunk.length > 0) {
                chunks.push(currentChunk.join(' '));
            }
            return chunks;
        }

        async function callGeminiAPI(prompt, generationConfig = {}) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory, generationConfig };
            const userApiKey = DOMElements.apiKeyInput.value.trim();
            if (!userApiKey) {
                throw new Error('Vui lòng nhập khóa API Gemini của bạn vào phần cấu hình.');
            }
            const apiKey = userApiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const responseBodyText = await response.text();
            if (!response.ok) {
                let errorMsg = `Lỗi API: ${response.status}`;
                 if (response.status === 400) {
                     errorMsg = 'Lỗi yêu cầu (400). Vui lòng kiểm tra lại khóa API và đảm bảo nó hợp lệ.';
                 } else if (response.status === 401 || response.status === 403) {
                     errorMsg = 'Lỗi xác thực API (401/403). Vui lòng kiểm tra lại khóa API bạn đã nhập.';
                } else {
                    try {
                        const errorDetail = JSON.parse(responseBodyText);
                        errorMsg += ` - ${errorDetail.error?.message || 'Không rõ lỗi'}`;
                    } catch (e) {
                        errorMsg += ` (${response.statusText || 'Không thể phân tích chi tiết lỗi'})`;
                    }
                }
                throw new Error(errorMsg);
            }
            if (!responseBodyText) throw new Error('API đã trả về một phản hồi trống.');
            const result = JSON.parse(responseBodyText);
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                const responseText = result.candidates[0].content.parts[0].text;
                if (generationConfig.responseMimeType === "application/json") {
                    try {
                        const match = responseText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                        const jsonString = match ? match[1].trim() : responseText.trim();
                        return JSON.parse(jsonString);
                    } catch (e) {
                        console.error("Lỗi phân tích JSON:", e);
                        console.error("Phản hồi nhận được từ AI:", responseText);
                        throw new Error("Phản hồi JSON không hợp lệ từ AI. Vui lòng thử lại.");
                    }
                }
                return responseText;
            } else {
                if (result.promptFeedback?.blockReason) throw new Error(`Yêu cầu bị chặn: ${result.promptFeedback.blockReason}`);
                throw new Error('Cấu trúc phản hồi API không mong muốn.');
            }
        }

        // --- DYNAMIC SECTION RENDERING ---
        function createOutputSection(id, title, isHtml = false) {
            const sectionId = `${id}Container`;
            let section = document.getElementById(sectionId);
            if (section) {
                section.querySelector('.output-content').innerHTML = '';
                 section.querySelector('h2').textContent = title;
            } else {
                section = document.createElement('div');
                section.id = sectionId;
                section.className = 'border border-gray-200 rounded-md';
                section.innerHTML = `
                    <div class="w-full flex justify-between items-center p-3 bg-gray-50">
                        <h2 class="text-lg font-semibold text-gray-800">${title}</h2>
                        <div class="flex items-center gap-2">
                            <button data-action="copy" title="Sao chép" class="p-1 text-gray-500 hover:bg-gray-200 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button>
                            <button data-action="toggle" title="Thu gọn/Mở rộng" class="p-1 text-gray-500 hover:bg-gray-200 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>
                    <div class="section-content p-4">
                        <div class="loading-spinner my-4 hidden"></div>
                        <div class="output-content ${isHtml ? 'prose' : 'whitespace-pre-wrap'}"></div>
                    </div>
                `;
                if (id.startsWith('popup') || id === 'aiAnswer') {
                    const container = id === 'aiAnswer' ? DOMElements.aiAnswerContainer : DOMElements.outputSections;
                    container.insertBefore(section, container.firstChild);
                } else {
                    DOMElements.outputSections.appendChild(section);
                }
            }
            return section;
        }
        
        // --- SELECTION POPUP LOGIC ---
        document.addEventListener('mouseup', handleTextSelection);
        document.addEventListener('mousedown', (e) => {
            if (!DOMElements.selectionPopup.contains(e.target)) {
                DOMElements.selectionPopup.style.display = 'none';
            }
        });

        function handleTextSelection(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (selectedText.length > 0 && selectedText.length < 50) {
                currentSelectedText = selectedText;
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                DOMElements.selectionPopup.style.display = 'flex';
                DOMElements.selectionPopup.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (DOMElements.selectionPopup.offsetWidth / 2)}px`;
                DOMElements.selectionPopup.style.top = `${rect.top + window.scrollY - DOMElements.selectionPopup.offsetHeight - 10}px`;
                const encodedText = encodeURIComponent(selectedText);
                DOMElements.popupVtudien.href = `https://vtudien.com/anh-viet/dictionary/nghia-cua-tu-${encodedText}`;
                DOMElements.popupCambridge.href = `https://dictionary.cambridge.org/dictionary/english-vietnamese/${encodedText}`;
                DOMElements.popupYouglish.href = `https://youglish.com/pronounce/${encodedText}/english?`;
                DOMElements.popupGoogle.href = `https://translate.google.com/?sl=en&tl=vi&text=${encodedText}&op=translate`;
            } else if (!DOMElements.selectionPopup.contains(e.target)) {
                DOMElements.selectionPopup.style.display = 'none';
            }
        }

        DOMElements.popupPronounce.addEventListener('click', () => { if (currentSelectedText) { const utterance = new SpeechSynthesisUtterance(currentSelectedText); utterance.lang = 'en-US'; window.speechSynthesis.speak(utterance); } });
        DOMElements.popupCopy.addEventListener('click', () => { if (currentSelectedText) copyTextToClipboard(currentSelectedText); });
        
        async function handlePopupAIAction(actionType) {
            if (!currentSelectedText) return;
            let config;
            if (actionType === 'translate') {
                config = { feature: 'popupTranslate', title: `Dịch AI cho: "${currentSelectedText}"`, prompt: (text) => `Translate this into Vietnamese: "${text}"`, isHtml: false };
            } else {
                config = { feature: 'popupIpa', title: `Phiên âm IPA cho: "${currentSelectedText}"`, prompt: (text) => `Provide only the IPA phonetic transcription for: "${text}"`, isHtml: false };
            }
            const section = createOutputSection(config.feature, config.title, config.isHtml);
            const loader = section.querySelector('.loading-spinner');
            const outputContent = section.querySelector('.output-content');
            loader.classList.remove('hidden');
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            try {
                const result = await callGeminiAPI(config.prompt(currentSelectedText));
                outputContent.textContent = result;
            } catch (error) {
                outputContent.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        DOMElements.popupTranslateAI.addEventListener('click', () => handlePopupAIAction('translate'));
        DOMElements.popupIPA.addEventListener('click', () => handlePopupAIAction('ipa'));

        // --- INITIAL SETUP & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) DOMElements.apiKeyInput.value = savedApiKey;
            populateVoiceList();
        });
        DOMElements.apiKeyInput.addEventListener('input', (e) => localStorage.setItem('geminiApiKey', e.target.value));
        DOMElements.toggleApiSection.addEventListener('click', () => { DOMElements.apiSectionContent.classList.toggle('hidden'); DOMElements.apiChevron.classList.toggle('rotate-180'); });
        DOMElements.toggleApiKeyVisibility.addEventListener('click', () => { const isPassword = DOMElements.apiKeyInput.type === 'password'; DOMElements.apiKeyInput.type = isPassword ? 'text' : 'password'; DOMElements.eyeIcon.classList.toggle('hidden', isPassword); DOMElements.eyeOffIcon.classList.toggle('hidden', !isPassword); });
        DOMElements.englishInput.addEventListener('input', () => {
            const text = DOMElements.englishInput.value;
            const charCount = text.length;
            const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
            DOMElements.textCounter.textContent = `${wordCount} từ / ${charCount} ký tự`;
        });
        DOMElements.fileUpload.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; DOMElements.fileNameSpan.textContent = `Đang đọc...`; const reader = new FileReader(); reader.onload = (e) => { mammoth.extractRawText({ arrayBuffer: e.target.result }).then(result => { DOMElements.englishInput.value = result.value; DOMElements.fileNameSpan.textContent = file.name; DOMElements.englishInput.dispatchEvent(new Event('input')); }).catch(err => showGlobalError("Không thể đọc file .docx.")); }; reader.readAsArrayBuffer(file); });
        
        // --- AI TASK CONTROL ---
        function addAiProcessControls(outputContent) {
            removeAiProcessControls();
            const controlDiv = document.createElement('div');
            controlDiv.id = 'aiProcessControls';
            controlDiv.className = 'flex items-center gap-2 mb-4 p-2 bg-gray-100 rounded-md';
            controlDiv.innerHTML = `
                <button id="aiPauseResumeBtn" class="bg-yellow-500 text-white py-1 px-3 rounded-md text-sm hover:bg-yellow-600">Tạm dừng</button>
                <button id="aiStopBtn" class="bg-red-600 text-white py-1 px-3 rounded-md text-sm hover:bg-red-700">Dừng hẳn</button>
                <span id="aiProgressIndicator" class="text-sm text-gray-600"></span>
            `;
            outputContent.prepend(controlDiv);

            document.getElementById('aiPauseResumeBtn').addEventListener('click', toggleAiPause);
            document.getElementById('aiStopBtn').addEventListener('click', stopAiProcess);
        }

        function removeAiProcessControls() {
            const controls = document.getElementById('aiProcessControls');
            if (controls) controls.remove();
        }

        function toggleAiPause() {
            aiProcessState.isPaused = !aiProcessState.isPaused;
            const btn = document.getElementById('aiPauseResumeBtn');
            if (btn) {
                btn.textContent = aiProcessState.isPaused ? 'Tiếp tục' : 'Tạm dừng';
                btn.classList.toggle('bg-yellow-500', !aiProcessState.isPaused);
                btn.classList.toggle('bg-blue-500', aiProcessState.isPaused);
            }
        }

        function stopAiProcess() {
            aiProcessState.shouldStop = true;
        }

        // --- FEATURE PROCESSING ---
        async function runAiTask(button, config) {
            const text = DOMElements.englishInput.value.trim();
            if (!text) { showGlobalError('Vui lòng nhập văn bản trước.'); return; }
            if (aiProcessState.isRunning) { showGlobalError('Một tác vụ AI khác đang chạy. Vui lòng đợi hoặc dừng tác vụ đó.'); return; }
            showGlobalError('');

            aiProcessState = { isRunning: true, isPaused: false, shouldStop: false };

            const section = createOutputSection(config.featureId, config.title, config.isHtml);
            const outputContent = section.querySelector('.output-content');
            const loader = section.querySelector('.loading-spinner');
            
            loader.classList.remove('hidden');
            button.disabled = true;
            outputContent.innerHTML = '';

            try {
                const chunks = chunkText(text);
                if (chunks.length > 1) addAiProcessControls(outputContent);
                
                const progressIndicator = document.getElementById('aiProgressIndicator');

                for (let i = 0; i < chunks.length; i++) {
                    if (aiProcessState.shouldStop) {
                        if(progressIndicator) progressIndicator.textContent = `Đã dừng bởi người dùng.`;
                        break;
                    }
                    while (aiProcessState.isPaused) {
                        if(progressIndicator) progressIndicator.textContent = `Đã tạm dừng. Nhấn "Tiếp tục" để chạy lại.`;
                        await new Promise(resolve => setTimeout(resolve, 200));
                        if (aiProcessState.shouldStop) break;
                    }
                    if (aiProcessState.shouldStop) {
                         if(progressIndicator) progressIndicator.textContent = `Đã dừng bởi người dùng.`;
                         break;
                    }
                    
                    if (progressIndicator) progressIndicator.textContent = `Đang xử lý phần ${i + 1}/${chunks.length}...`;
                    
                    const result = await callGeminiAPI(config.promptFn(chunks[i]), config.generationConfig);
                    config.resultCombinerFn(result, outputContent, chunks.length > 1);
                }
            } catch (error) {
                outputContent.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            } finally {
                loader.classList.add('hidden');
                button.disabled = false;
                removeAiProcessControls();
                aiProcessState = { isRunning: false, isPaused: false, shouldStop: false };
            }
        }

        function handleOfflineLookup(button) {
            const text = DOMElements.englishInput.value;
            if (!text.trim()) { showGlobalError('Vui lòng nhập văn bản trước.'); return; }
            showGlobalError('');

            const section = createOutputSection('offline-lookup', 'Tra từ (Offline)');
            const outputContent = section.querySelector('.output-content');
            outputContent.innerHTML = '';
            const tokens = text.split(/(\b[a-zA-Z']+\b)/);
            tokens.forEach(token => {
                if (/\b[a-zA-Z']+\b/.test(token)) {
                    const wordSpan = document.createElement('span');
                    wordSpan.textContent = token;
                    wordSpan.className = 'clickable-word-offline';
                    wordSpan.onclick = () => showDictionaryModal(token.toLowerCase());
                    outputContent.appendChild(wordSpan);
                } else {
                    outputContent.appendChild(document.createTextNode(token));
                }
            });
        }

        const ipaResultCombiner = (result, container) => {
            result.forEach(item => {
                if (/\b[a-zA-Z']+\b/.test(item.word)) {
                    const el = document.createElement('div');
                    el.className = 'word-with-ipa';
                    el.innerHTML = `<span class="ipa-text-above">${item.ipa || ' '}</span><span class="original-word-below">${item.word}</span>`;
                    el.querySelector('.original-word-below').onclick = () => showDictionaryModal(item.word.toLowerCase());
                    container.appendChild(el);
                } else {
                    container.appendChild(document.createTextNode(item.word));
                }
            });
        };

        const genericResultCombiner = (result, container, isAppending, isHtml) => {
            const content = isHtml ? result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') : result;
            if (isAppending && container.innerHTML !== '') {
                container.innerHTML += '<hr class="my-4">' + content;
            } else {
                container.innerHTML += content;
            }
        };

        const featureConfigs = { 
            ipa: {
                featureId: 'ipa', title: 'Phiên âm (AI)', isHtml: true,
                promptFn: (chunk) => `For the following English text, provide a JSON array where each object represents a component of the text (word, punctuation, or whitespace). Each object must have two keys: "word" and "ipa". For English words, provide the phonetic transcription. For all other characters (punctuation, spaces, newlines), the "ipa" key must be an empty string. Preserve all original characters to reconstruct the text perfectly. Text: "${chunk}"`,
                generationConfig: { responseMimeType: "application/json" },
                resultCombinerFn: ipaResultCombiner
            },
            translate: { 
                featureId: 'translate', title: "Dịch (AI)", isHtml: false,
                promptFn: (text) => `Translate the following English text into Vietnamese: "${text}"`,
                generationConfig: {},
                resultCombinerFn: (result, container, isAppending) => genericResultCombiner(result, container, isAppending, false)
            }, 
            grammar: { 
                featureId: 'grammar', title: "Ngữ pháp (AI)", isHtml: true,
                promptFn: (text) => `Hãy giải thích ngữ pháp của đoạn văn sau bằng tiếng Việt cho người Việt đang học tiếng Anh. Sử dụng các đề mục, gạch đầu dòng rõ ràng. Giải thích các thì, cấu trúc câu và từ vựng quan trọng. Đoạn văn: "${text}"`,
                generationConfig: {},
                resultCombinerFn: (result, container, isAppending) => genericResultCombiner(result, container, isAppending, true)
            },
            askAI: {
                featureId: 'aiAnswer', title: "Trả lời cho câu hỏi", isHtml: true,
                promptFn: (chunk) => `Dựa vào văn bản sau: "${chunk}".\n\nHãy trả lời câu hỏi sau bằng tiếng Việt: "${DOMElements.aiQuestionInput.value.trim()}"`,
                generationConfig: {},
                resultCombinerFn: (result, container, isAppending) => genericResultCombiner(result, container, isAppending, true)
            }
        };

        DOMElements.featureButtons.forEach(button => { 
            button.addEventListener('click', () => { 
                const feature = button.dataset.feature; 
                if (feature === 'offline-lookup') {
                    handleOfflineLookup(button);
                } else {
                    runAiTask(button, featureConfigs[feature]);
                }
            }); 
        });
        
        DOMElements.outputSections.addEventListener('click', (e) => { const button = e.target.closest('button[data-action]'); if (!button) return; const action = button.dataset.action; const section = button.closest('.border'); const contentWrapper = section.querySelector('.section-content'); if (action === 'copy') { const textToCopy = section.querySelector('.output-content').innerText; copyTextToClipboard(textToCopy); } else if (action === 'toggle') { const isCollapsed = contentWrapper.style.maxHeight === '0px'; if (isCollapsed) { contentWrapper.style.maxHeight = contentWrapper.scrollHeight + "px"; contentWrapper.style.padding = "1rem"; button.querySelector('svg').classList.remove('rotate-180'); } else { contentWrapper.style.maxHeight = '0px'; contentWrapper.style.padding = "0 1rem"; button.querySelector('svg').classList.add('rotate-180'); } } });
        
        DOMElements.askAIButton.addEventListener('click', () => {
            const question = DOMElements.aiQuestionInput.value.trim();
            if (!question) { showGlobalError("Vui lòng nhập câu hỏi."); return; }
            const config = { ...featureConfigs.askAI, title: `Trả lời cho: "${question}"`};
            runAiTask(DOMElements.askAIButton, config);
        });

        // --- SPEECH SYNTHESIS LOGIC (REFACTORED) ---
        function updatePlaybackIcons() { 
            DOMElements.playIcon.classList.toggle('hidden', ttsState === 'playing');
            DOMElements.pauseIcon.classList.toggle('hidden', ttsState !== 'playing');
        }

        function populateVoiceList() { voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en')); DOMElements.mainVoiceSelect.innerHTML = ''; voices.forEach(voice => { const option = document.createElement('option'); option.textContent = `${voice.name} (${voice.lang})`; option.setAttribute('data-name', voice.name); DOMElements.mainVoiceSelect.appendChild(option); }); }
        if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = populateVoiceList; }
        
        DOMElements.mainRateSlider.addEventListener('input', () => { 
            const rate = DOMElements.mainRateSlider.value; 
            DOMElements.mainRateValue.textContent = `${rate}x`; 
            if (mainUtterance) mainUtterance.rate = parseFloat(rate); 
        });

        DOMElements.mainPlayPauseButton.addEventListener('click', () => {
            const textToSpeak = DOMElements.englishInput.value.trim();
            if (!textToSpeak) return;

            if (ttsState === 'playing') {
                speechSynthesis.pause();
            } else if (ttsState === 'paused') {
                speechSynthesis.resume();
            } else { // ttsState === 'idle'
                speechSynthesis.cancel(); 
                mainUtterance = new SpeechSynthesisUtterance(textToSpeak);
                const selectedVoiceName = DOMElements.mainVoiceSelect.options[DOMElements.mainVoiceSelect.selectedIndex].getAttribute('data-name');
                mainUtterance.voice = voices.find(v => v.name === selectedVoiceName);
                mainUtterance.rate = parseFloat(DOMElements.mainRateSlider.value);
                
                mainUtterance.onstart = () => { ttsState = 'playing'; updatePlaybackIcons(); };
                mainUtterance.onpause = () => { ttsState = 'paused'; updatePlaybackIcons(); };
                mainUtterance.onresume = () => { ttsState = 'playing'; updatePlaybackIcons(); };
                mainUtterance.onend = () => { ttsState = 'idle'; mainUtterance = null; updatePlaybackIcons(); };
                mainUtterance.onerror = () => { ttsState = 'idle'; updatePlaybackIcons(); };

                speechSynthesis.speak(mainUtterance);
            }
        });

        DOMElements.mainStopButton.addEventListener('click', () => {
            speechSynthesis.cancel();
        });
        
        // --- DICTIONARY MODAL LOGIC ---
        function showDictionaryModal(word) { DOMElements.modalWord.textContent = word; DOMElements.modalIpa.textContent = ''; DOMElements.modalMeaning.textContent = ''; DOMElements.modalDynamicContent.innerHTML = ''; DOMElements.modalDefinitionLoading.classList.remove('hidden'); DOMElements.modalDefinitionContainer.classList.add('opacity-50'); const encodedWord = encodeURIComponent(word); DOMElements.modalCopyButton.onclick = () => copyTextToClipboard(word); DOMElements.vtudienLink.href = `https://vtudien.com/anh-viet/dictionary/nghia-cua-tu-${encodedWord}`; DOMElements.youglishLink.href = `https://youglish.com/pronounce/${encodedWord}/english?`; DOMElements.cambridgeLink.href = `https://dictionary.cambridge.org/dictionary/english-vietnamese/${encodedWord}`; DOMElements.dictionaryModal.classList.remove('hidden'); DOMElements.dictionaryModal.querySelector('.modal-content').classList.add('scale-100'); fetchWordDefinition(word); if (DOMElements.autoPronounceCheckbox.checked) speakWord(word); }
        function hideDictionaryModal() { window.speechSynthesis.cancel(); DOMElements.dictionaryModal.querySelector('.modal-content').classList.remove('scale-100'); setTimeout(() => DOMElements.dictionaryModal.classList.add('hidden'), 300); }
        async function fetchWordDefinition(word) { try { const prompt = `Provide a short IPA transcription and a concise Vietnamese meaning for the word: "${word}". Format as a JSON object: {"ipa": "...", "meaning": "..."}`; const config = { responseMimeType: "application/json" }; const data = await callGeminiAPI(prompt, config); DOMElements.modalIpa.textContent = data.ipa || 'N/A'; DOMElements.modalMeaning.textContent = data.meaning || 'Không tìm thấy'; } catch (err) { DOMElements.modalIpa.textContent = 'Lỗi'; DOMElements.modalMeaning.textContent = err.message; } finally { DOMElements.modalDefinitionLoading.classList.add('hidden'); DOMElements.modalDefinitionContainer.classList.remove('opacity-50'); } }
        async function generateModalContent(word, type) { DOMElements.modalDynamicContent.innerHTML = '<div class="loading-spinner mx-auto"></div>'; let prompt; let renderer; if (type === 'sentence') { prompt = `Tạo 2 câu ví dụ cho từ tiếng Anh "${word}". Với mỗi câu, cung cấp phiên âm IPA và dịch nghĩa tiếng Việt. Trả về dưới dạng mảng JSON, mỗi đối tượng có các khóa: "sentence", "ipa", "translation".`; renderer = (data) => data.map(item => `<div class="p-3 border rounded-md bg-gray-50"><p class="font-semibold">${item.sentence}</p><p class="text-sm text-gray-600">/${item.ipa}/</p><p class="text-sm text-blue-600">${item.translation}</p></div>`).join(''); } else { prompt = `Tạo 3 từ liên quan (đồng nghĩa, trái nghĩa, hoặc cùng họ từ) cho từ "${word}". Với mỗi từ, cung cấp loại quan hệ, phiên âm IPA và nghĩa tiếng Việt. Trả về dưới dạng mảng JSON, mỗi đối tượng có các khóa: "word", "relation", "ipa", "meaning".`; renderer = (data) => data.map(item => `<div class="p-3 border rounded-md bg-gray-50"><p class="font-semibold">${item.word} <span class="text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded-full">${item.relation}</span></p><p class="text-sm text-gray-600">/${item.ipa}/</p><p class="text-sm text-blue-600">${item.meaning}</p></div>`).join(''); } try { const config = { responseMimeType: "application/json" }; const data = await callGeminiAPI(prompt, config); DOMElements.modalDynamicContent.innerHTML = renderer(data); } catch (error) { DOMElements.modalDynamicContent.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}</p>`; } }
        DOMElements.closeModalButton.addEventListener('click', hideDictionaryModal);
        DOMElements.dictionaryModal.addEventListener('click', (e) => { if (e.target === DOMElements.dictionaryModal) hideDictionaryModal(); });
        DOMElements.generateSentenceButton.addEventListener('click', () => generateModalContent(DOMElements.modalWord.textContent, 'sentence'));
        DOMElements.generateWordsButton.addEventListener('click', () => generateModalContent(DOMElements.modalWord.textContent, 'words'));
        DOMElements.modalRateSlider.addEventListener('input', () => DOMElements.modalRateValue.textContent = `${DOMElements.modalRateSlider.value}x`);
        function speakWord(word) { if (speechSynthesis.speaking) speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(word); utterance.lang = 'en-US'; utterance.rate = parseFloat(DOMElements.modalRateSlider.value); speechSynthesis.speak(utterance); }
        DOMElements.modalSpeakButton.addEventListener('click', () => speakWord(DOMElements.modalWord.textContent));
    </script>
</body>
</html>
